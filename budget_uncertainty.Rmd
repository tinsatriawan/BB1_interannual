---
title: "BB1 plots"
author: "Tin"
date: "05/05/2021"
output: 
  html_document: 
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
  theme: lumen

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(plyr)
library(ggplot2)
library(lubridate)
library(naniar)
library(tidyr)
library(plotly)
library(knitr)
library(data.table)
library(kableExtra)
library(ggsci)
library(effects)
library(tidyverse)
library(zoo)
library(caret)
library(ggpubr)
library(gridExtra)
library(lognorm)
library(reshape2)
library(matrixStats)
library(gtools)
library(dplyr)


```







```{r read data, include = F, message = F, warning = F}

# define directory

dir_rf <- "G:\\.shortcut-targets-by-id\\1txCh9lZ7VGCujXGvBaJCMVnuxT-65q4K\\Micromet Lab\\Projects\\2014-Burns Bog\\Flux-tower\\flux_data\\for_uncertainty\\RF_results"

dir_unc <- "G:\\.shortcut-targets-by-id\\1txCh9lZ7VGCujXGvBaJCMVnuxT-65q4K\\Micromet Lab\\Projects\\2014-Burns Bog\\Flux-tower\\flux_data\\for_uncertainty"

# ## read random forest gap-filled NEE result (already averaged)
# RF_NEE <- readRDS(paste0(dir_rf,"/BB_NEE_rf_result_for_uncertainty"))

## read NEE RF gapfilling with 20x iteration
result_RF_NEE <- readRDS(paste0(dir_rf,"/BB_NEE_rf_result"))

## read CH4 RF gapfilling with 20x iteration
result_RF_FCH4 <- read_csv(paste0(dir_rf,"/BB_FCH4_rf_result.csv"))

## read REddyProcOuput 
REddyProcOutput<- readRDS(paste0(dir_unc,"/ReddyProcOutput"))
REddyProcOutput_ori <- REddyProcOutput
REddyProcOutput <- REddyProcOutput$sTEMP
REddyProcOutput$date <- as.Date(REddyProcOutput$sDateTime, format="%Y-%m-%d %H:%M:%S")


# read flux & met data
BB1 <- fread(paste0(dir_unc,"/BB_L3.csv"))
BB1[BB1 == -9999] <- NA
BB1$DATE <- as.POSIXct(BB1$DATE, tz = "UTC")
BB1$date <- as.Date(BB1$DATE, format="%Y-%m-%d %H:%M:%S")

BB1 <- BB1 %>%
  mutate(period = NA, 
         season = NA)


# filter date
BB1 <- BB1 %>% 
  filter(DATE >= as.POSIXct("2015-10-01 00:30:00", tz = "UTC") & DATE < as.POSIXct("2021-10-01 00:00:00", tz = "UTC")) 
REddyProcOutput <- REddyProcOutput %>% 
  filter(date >= "2015-10-01" & date < "2021-10-01") 
result_RF_FCH4 <- result_RF_FCH4 %>% 
  filter(DateTime >= as.POSIXct("2015-10-01 00:30:00", tz = "UTC") & DateTime < as.POSIXct("2021-10-01 00:00:00", tz = "UTC")) 
result_RF_NEE <- result_RF_NEE %>% 
  filter(DateTime >= as.POSIXct("2015-10-01 00:30:00", tz = "UTC") & DateTime < as.POSIXct("2021-10-01 00:00:00", tz = "UTC"))


#Conversion factors
ch4_conv <- 12.01/(10^6)
co2_conv <- 12.01/(10^6) 
d.avg <- 1800 * 48  # 60s * 30min * 2 hours * 24 hours

```

```{r functions}

###### functions #######


# function for setting year period
set_period <- function(data) {
  y_2015_2016 <- data$date >= "2015-10-01" & data$date < "2016-10-01"
  y_2016_2017 <- data$date >= "2016-10-01" & data$date < "2017-10-01"
  y_2017_2018 <- data$date >= "2017-10-01" & data$date < "2018-10-01"
  y_2018_2019 <- data$date >= "2018-10-01" & data$date < "2019-10-01"
  y_2019_2020 <- data$date >= "2019-10-01" & data$date < "2020-10-01"
  y_2020_2021 <- data$date >= "2020-10-01" & data$date < "2021-10-01"
  
  data$period[y_2015_2016] <- "2015-2016"
  data$period[y_2016_2017] <- "2016-2017"
  data$period[y_2017_2018] <- "2017-2018"
  data$period[y_2018_2019] <- "2018-2019"
  data$period[y_2019_2020] <- "2019-2020"
  data$period[y_2020_2021] <- "2020-2021"
  
  data
}

# set season 
set_season <- function(input, date_vector){
  input$month_local <- month(date_vector)
  GS <- input$month_local %in% c(4, 5, 6, 7, 8, 9)
  NGS <- input$month_local %in% c(10, 11, 12, 1, 2, 3)
  input$season <- NA
  input$season[GS] <- "growing season"
  input$season[NGS] <- "non-growing season"
  input
}

# calculate GS
calculate_GS <- function(input, var, ind = ustar_ind){  # variable = c("GPP_f", "NEE_f", "Reco")
  input <- set_season(input, input$date)
  input_GS <- input %>% 
    filter(season == "growing season")
  
  period <- unique (input$period)
  cumsum_i <- NA
  GS_output <- NA
  
  for(i in period){
    cumsum_i <- input_GS %>% filter(period == i) 
    cumsum_i <- calculate_cumsum_unc(data = cumsum_i, 
                                   ind = ind, 
                                   variable = var, 
                                   start_mean = 0, 
                                   start_SD = 0)
    cumsum_i <- cumsum_i[[1]] %>% 
      select("date", "SD", "mean") %>% 
      mutate(upper = mean + SD, 
             lower = mean - SD, 
             period = i)
    if(i == "2015-2016") {
      GS_output <- cumsum_i
    } else {
      GS_output <- rbind(GS_output, cumsum_i)
    }
  }
  
  GS_output <- GS_output %>% 
  group_by(period) %>% 
  filter(date == max(date)) %>%  # pick the last time of each day to get daily cumulative
  ungroup() %>% 
  mutate(joint_CI = SD * 1.96,
         upper = mean + joint_CI, 
         lower = mean - joint_CI)
  
  GS_output 
  
}

# calculate NGS
calculate_NGS <- function(input){
  input <- set_season(input, input$date)
  NGS_output <- input %>% 
    group_by(period, season) %>% 
    filter(date == max(date) & season == "non-growing season") %>% # pick the last time of each day to get daily cumulative
    ungroup()
  NGS_output
}

```



```{r wrangling for uncertainty analysis}

###### wrangling REddyProcOutput ######

REddyProcOutput <- REddyProcOutput %>% 
  mutate(date = as.Date(as.POSIXct(sDateTime - 15*60))) %>% # midnight belongs to the previous
  mutate(year_local = year(date), 
         month_local = month(date), 
         floor_date = floor_date(date, "month")
  ) %>% 
  rename(ustar_season = season) %>% 
  set_period()



```


```{r uncertainty analysis}

# set season 
GS <- REddyProcOutput$month_local %in% c(4, 5, 6, 7, 8, 9)
NGS <- REddyProcOutput$month_local %in% c(10, 11, 12, 1, 2, 3)
REddyProcOutput$season[GS] <- "growing season"
REddyProcOutput$season[NGS] <- "non-growing season"

## summary
summary(REddyProcOutput$NEE_fsd)
plot(NEE_fsd ~ NEE_fall, slice(REddyProcOutput, sample.int(nrow(REddyProcOutput),400)))


####################### Random Uncertainty ##########################

# for random uncertainty, we only do it for NEE. No random uncertainty calculation for GPP & Reco in REddyProc


# First we need to quantify the error terms, i.e. model-data residuals. For all the records of good quality, we have an original measured value NEE_uStar_orig and modelled value from MDS gapfilling, NEE_uStar_fall. The residual of bad-quality data is set to missing.

REddyProcOutput <- REddyProcOutput %>%
  mutate(
    resid = ifelse(NEE_fqc == 0, NEE_orig - NEE_fall, NA )
  )

# #Now we can inspect the the autocorrelation of the errors.
 
acf(REddyProcOutput$resid, na.action = na.pass, main = "")

# Computation of effective number of observations is provided by function computeEffectiveNumObs from package lognorm based on the empirical autocorrelation function for given model-data residuals.

autoCorr <- computeEffectiveAutoCorr(REddyProcOutput$resid)
nEff <- computeEffectiveNumObs(REddyProcOutput$resid, na.rm = T)
c(nEff = nEff, nObs = sum(is.finite(REddyProcOutput$resid)))
#Now we can use the formulas for the sum and the mean of correlated normally distributed variables to compute the uncertainty of the mean.


#----- Daily Aggregation for random uncertainty ------#


aggDayRand <- REddyProcOutput %>% 
  ddply("date", summarize, 
        DateTime = first(sDateTime), 
        nRec = sum(NEE_fqc == 0, na.rm = TRUE),
        nEff = computeEffectiveNumObs(resid, effAcf = !!autoCorr, na.rm = TRUE),
        NEE = mean(NEE_f, na.rm = TRUE)* d.avg * co2_conv,
        sdNEE = if (nEff <= 1)
          NA_real_
          else sqrt(mean(NEE_fsd^2, na.rm = TRUE) / (nEff - 1)* d.avg * co2_conv),
        sdNEEuncorr = if (nRec == 0)
          NA_real_
        else sqrt(mean(NEE_fsd^2, na.rm = TRUE) / (nRec - 1)* d.avg * co2_conv)
        ) %>% 
  mutate( 
    NEE_U = NEE + sdNEE, 
    NEE_L = NEE - sdNEE)


# Plot daily random uncertainty

(aggDayRand %>% 
  filter(date >= "2020-03-01" & date <= "2020-05-01") %>%
  ggplot(aes(x = date, y = NEE)) +
    geom_line() +
    geom_ribbon(aes(ymin = NEE_L, ymax = NEE_U), 
              alpha=0.1, 
              linetype="dashed",
              color="grey") +
    labs(x = "year", 
         y = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())


#--------- annual aggregation for random uncertainty ---------#


aggAnnualRand <- REddyProcOutput %>% 
  ddply("period", summarize, 
        DateTime = first(sDateTime), 
        nRec = sum(NEE_fqc == 0, na.rm = TRUE),
        nEff = computeEffectiveNumObs(resid, effAcf = !!autoCorr, na.rm = TRUE),
        NEE = mean(NEE_f, na.rm = TRUE)* d.avg * co2_conv * 365,
        sdNEE = if (nEff <= 1)
          NA_real_
          else sqrt(mean(NEE_fsd^2, na.rm = TRUE) / (nEff - 1)* d.avg * co2_conv * 365),
        sdNEEuncorr = if (nRec == 0)
          NA_real_
        else sqrt(mean(NEE_fsd^2, na.rm = TRUE) / (nRec - 1)* d.avg * co2_conv * 365)
        ) %>% 
  mutate( 
    NEE_U = NEE + sdNEE, 
    NEE_L = NEE - sdNEE)


# note: GPP and Reco don't have random uncertainty because their fsd are not calculated in REddyPro


######### systematic uncertainty #########

# uncertainty due to different u* threshold

uStarSuffixes <- colnames(REddyProcOutput_ori[["sUSTAR_SCEN"]])[-1]
NEE_suffix_f <- NA
GPP_suffix_f <- NA
RECO_suffix_f <- NA
  
for (i in 1:length(uStarSuffixes)) {
  NEE_suffix_f[i] <- paste0("NEE_", uStarSuffixes[i], "_f" )
  GPP_suffix_f[i] <- paste0("GPP_", uStarSuffixes[i], "_f" )
  RECO_suffix_f[i] <- paste0("Reco_", uStarSuffixes[i])
}

NEE_suffix_f[1] <- "NEE_f"
GPP_suffix_f[1] <- "GPP_f"
RECO_suffix_f[1] <- "Reco"


#--------------- Daily aggregation for systematic uncertainty--------------#

# Compute the mean NEE for each u* threshold 

n_iteration <- 20

compute_sdAggDayUstar <- function(data, type){
  if(type == "NEE") {
    col_suffix <- NEE_suffix_f
  } else if (type == "GPP") {
    col_suffix <- GPP_suffix_f
  } else if (type == "RECO") {
    col_suffix <- RECO_suffix_f
  } else if (type == "RF") {
    col_suffix <- as.character(c(1:n_iteration))
  }
  
  # browser()
  # create NEE, GPP, RECO data
  half_hourly <- data %>% select(date|one_of(col_suffix))
  m_half_hourly <- melt(half_hourly, id.vars = "date") 
  
  # calculate daily NEE, GPP, RECO from the average of each u* scen 
  daily <- dcast(m_half_hourly, date ~ variable, 
                 fun.agg = function(x) mean(x, na.rm = T) * d.avg *co2_conv)
  
  if(type == "RF"){
    sd_daily <- data.frame(daily, SD = rowSds(as.matrix(daily[-1])))
    sd_daily$mean <- rowMeans(sd_daily[-1])
    sd_daily <- sd_daily %>% 
      mutate(upper = mean + SD,  # get mean RF + SD
             lower = mean - SD)  # get mean RF - SD
  } else{
    # calculate the SD of mean NEE, GPP, RECO from across different u* scen
    sd_daily <- data.frame(daily, SD = rowSds(as.matrix(daily[-1]))) %>% 
      mutate(upper = get(col_suffix[1]) + SD,  # get NEE_uStar_f + SD
             lower = get(col_suffix[1]) - SD)  # get NEE_uStar_f - SD
  }
  
  sd_daily
  
  }



###  calculate daily systematic uncertainty from MDS ## 

sdAggDayUstar_NEE <- compute_sdAggDayUstar(REddyProcOutput, "NEE")  # not final, still needs to replace long gaps
sdAggDayUstar_GPP <- compute_sdAggDayUstar(REddyProcOutput, "GPP")  # not final, still needs to replace long gaps
sdAggDayUstar_RECO <- compute_sdAggDayUstar(REddyProcOutput, "RECO")  # this is the final value


######--------- Compute daily SD values from NEE RF gapfilling ------------#########


# define long gaps that will be replaced with SD from RF

long_gaps <- which((sdAggDayUstar_NEE$date >="2015-12-01 00:30:00" &
  sdAggDayUstar_NEE$date < "2016-02-21 00:30:00") | (sdAggDayUstar_NEE$date >= "2016-10-22" &
  sdAggDayUstar_NEE$date < "2017-01-21"))


# compute SD NEE from 20x iteration of RF NEE

result_RF_NEE_wide <- result_RF_NEE %>% 
  pivot_wider(id_cols = DateTime, 
              names_from = iteration,
              values_from = NEE_RF_filled) %>% 
  mutate(DateTime = date(DateTime)) %>% 
  rename(date = DateTime)

sdAggDay_RF_NEE <- compute_sdAggDayUstar(result_RF_NEE_wide, "RF")



######------ replace long gaps values with RF ----------########### 

# replace long gaps in sdAggDayUstar_NEE from MDS with RF result
sdAggDayUstar_NEE_combined <- sdAggDayUstar_NEE
sdAggDayUstar_NEE_combined$NEE_f[long_gaps] <- sdAggDay_RF_NEE$mean[long_gaps]
sdAggDayUstar_NEE_combined$SD[long_gaps] <- sdAggDay_RF_NEE$SD[long_gaps]
sdAggDayUstar_NEE_combined$upper[long_gaps] <- sdAggDay_RF_NEE$upper[long_gaps]
sdAggDayUstar_NEE_combined$lower[long_gaps] <- sdAggDay_RF_NEE$lower[long_gaps]

# we will use RECO as it is, no gaps 

# replace long gaps in sdAggDayUstar_GPP from MDS with NEE-RECO result
sdAggDayUstar_GPP_combined <- sdAggDayUstar_GPP
sdAggDayUstar_GPP_combined$GPP_f[long_gaps] <- sdAggDayUstar_RECO$Reco[long_gaps] - sdAggDay_RF_NEE$mean[long_gaps]
sdAggDayUstar_GPP_combined$SD[long_gaps] <- sqrt(sdAggDayUstar_RECO$SD[long_gaps]^2 + sdAggDay_RF_NEE$SD[long_gaps]^2)
sdAggDayUstar_GPP_combined$upper[long_gaps] <- sdAggDayUstar_GPP_combined$GPP_f[long_gaps] + sdAggDayUstar_GPP_combined$SD[long_gaps]
sdAggDayUstar_GPP_combined$lower[long_gaps] <- sdAggDayUstar_GPP_combined$GPP_f[long_gaps] - sdAggDayUstar_GPP_combined$SD[long_gaps]


# plot daily u* uncertainty 

plot_uncertainty <- function(data, type) {
  if(type == "NEE") {
    variable <- NEE_suffix_f[1]
  } else if (type == "GPP") {
    variable <- GPP_suffix_f[1]
  } else if (type == "RECO") {
    variable <- RECO_suffix_f[1]
  }
  # browser()
  data %>% 
    # filter(date >= "2016-10-15" & date <= "2017-02-01") %>%
    ggplot(aes(x = date, y = get(variable))) +
      geom_line() +
      geom_ribbon(aes(ymin = lower, ymax = upper), 
                alpha=0.1, 
                linetype="dashed",
                color="grey") +
      labs(x = "year", 
           y = bquote(.(type) ~ '(g C' ~m^-2~ day^-1*')'), 
           colour = "") +
      theme_bw()
}


aggDayUstar_NEE_plot <- (plot_uncertainty(sdAggDayUstar_NEE_combined, "NEE"))
aggDayUstar_GPP_plot <- (plot_uncertainty(sdAggDayUstar_GPP_combined, "GPP"))
aggDayUstar_RECO_plot <- (plot_uncertainty(sdAggDayUstar_RECO, "RECO"))


(aggDayUstar_NEE_plot)
(aggDayUstar_GPP_plot)
(aggDayUstar_RECO_plot)




#--------- annual aggregation for systematic uncertainty ---------#

# Compute the mean NEE for each u* threshold


aggAnnualUstar <- REddyProcOutput %>%
  ddply("period", summarize,
        DateTime = first(sDateTime),
        NEE_f = mean(NEE_f, na.rm = TRUE)* d.avg * co2_conv * 365.5,
        U05 = mean(NEE_U05_f, na.rm = TRUE)* d.avg * co2_conv * 365.5,
        U50 = mean(NEE_U50_f, na.rm = TRUE)* d.avg * co2_conv * 365.5,
        U95 = mean(NEE_U95_f, na.rm = TRUE)* d.avg * co2_conv * 365.5,
        )

sdAggAnnualUstar <- cbind(aggAnnualUstar$period, transform(aggAnnualUstar[ , c(3:6)],
                           SD=apply(aggAnnualUstar,1, sd, na.rm = TRUE))) %>%
                  mutate(
                    date = aggAnnualUstar$DateTime,
                    NEE = NEE_f,
                    NEE_U = NEE_f + SD,
                    NEE_L = NEE_f - SD,
                  )



######### calculation from Marion  

# only to check if the values are too far off

MN_aggAnnualUstar <- REddyProcOutput %>% 
  ddply("period", summarize, 
        L.2 = mean(NEE_U05_f, na.rm = TRUE) * d.avg * co2_conv * 365.5,
        U.2 = mean(NEE_U95_f, na.rm = TRUE) * d.avg * co2_conv * 365.5) %>% 
  mutate(std.2 = (U.2 - L.2)/(2 * 1.645), 
         CI95.2 = std.2 * 1.96)




######## joint uncertainty ###########


#---------- daily joint uncertainty -----------#

sdDayNEE <- data.frame(
  date = aggDayRand$date,
  sdRand = aggDayRand$sdNEE,
  sdUstar = sdAggDayUstar_NEE$SD,
  sdComb = sqrt(aggDayRand$sdNEE^2 + sdAggDayUstar_NEE$SD^2) 
) %>% 
  mutate(
    NEE = aggDayRand$NEE,
    NEE_U = aggDayRand$NEE + sdComb,
    NEE_L = aggDayRand$NEE - sdComb,
  )


# Plot daily joint uncertainty 
(sdDayNEE %>% 
  filter(date >= "2020-03-01" & date <= "2020-05-01") %>% 
  ggplot(aes(x = date, y = NEE)) +
    geom_line() +
    geom_ribbon(aes(ymin = NEE_L, ymax = NEE_U), 
              alpha=0.1, 
              linetype="dashed",
              color="grey") +
    labs(x = "year", 
         y = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())


#---------- annual joint uncertainty -----------#

sdAnnualNEE <- data.frame(
  period = aggAnnualRand$period,
  sdRand = aggAnnualRand$sdNEE,
  sdUstar = sdAggAnnualUstar$SD,
  sdComb = sqrt(aggAnnualRand$sdNEE^2 + sdAggAnnualUstar$SD^2) 
) %>% 
  mutate(
    NEE = aggAnnualRand$NEE,
    NEE_U = aggAnnualRand$NEE + sdComb,
    NEE_L = aggAnnualRand$NEE - sdComb,
  )

```

```{r cumsum uncertainty for NEE}



######################### Cumulative random uncertainty #############################

aggDayRand_cum <- REddyProcOutput %>% 
  group_by(period, isna = is.na(NEE_f)) %>% 
  mutate(t = (seq(1, length(sDateTime), by = 1)) * 30 * 60) %>%  # create cumulative timestep
  mutate(DateTime = date(sDateTime),
         n_NEE_fqc = ifelse(NEE_fqc != 0 |is.na(NEE_fqc), 0, 1),
         nRec = cumsum(n_NEE_fqc == 1), 
         NEE = ifelse(isna, NA, cummean(NEE_f) * co2_conv * t),
         sdNEE = ifelse(isna, NA, cummean(NEE_fsd^2))
  ) %>% 
  group_by(date) %>% 
  filter(sDateTime == max(sDateTime)) %>%  # pick the last time of each day to get daily cumulative
  ungroup() %>%
  mutate(nEff = aggDayRand$nEff) %>%  # get nEff from the daily random uncertainty table
  group_by(period) %>% 
  mutate(nEff = cumsum(nEff))%>%  # calculate cumulative daily nEff 
  ungroup() %>%
  mutate(sdNEE = if(nEff <= 1)
            NA_real_
          else ifelse(isna, NA, sqrt(sdNEE / (nEff - 1)  * co2_conv * t)),
          sdNEEuncorr = if(nRec == 0)
            NA_real_
          else ifelse(isna, NA, sqrt(sdNEE / (nRec - 1) * co2_conv * t))
  ) %>%
  mutate(sdNEE = sdNEE,
         NEE = NEE) %>% 
  mutate( 
    NEE_U = NEE + sdNEE, 
    NEE_L = NEE - sdNEE) %>% 
  select(colnames(aggDayRand))


# check plot 

(aggDayRand %>% 
    mutate(cumsum = cumsum(NEE)) %>%
  filter(date >= "2015-07-01" & date <= "2015-08-20") %>%
  ggplot(aes(x = date, y = cumsum)) +
    geom_line() +
    theme_bw())

# check cumulative random uncertainty plot
(aggDayRand_cum %>% 
  filter(date >= "2015-07-01" & date <= "2015-08-20") %>%
  ggplot(aes(x = date, y = NEE)) +
    geom_line() +
    geom_ribbon(aes(ymin = NEE_L, ymax = NEE_U), 
              alpha=0.1, 
              linetype="dashed",
              color="grey") +
    labs(x = "year", 
         y = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())




################## cumulative systematic uncertainty ####################


sdAggDayUstar_NEE_combined <- set_period(sdAggDayUstar_NEE_combined)


sdAggDayUstar_NEE_combined$month_local <- month(sdAggDayUstar_NEE_combined$date)

# set season 
GS <- sdAggDayUstar_NEE_combined$month_local %in% c(4, 5, 6, 7, 8, 9)
NGS <- sdAggDayUstar_NEE_combined$month_local %in% c(10, 11, 12, 1, 2, 3)
sdAggDayUstar_NEE_combined$season[GS] <- "growing season"
sdAggDayUstar_NEE_combined$season[NGS] <- "non-growing season"


long_gaps <- which((sdAggDayUstar_NEE_combined$date >="2015-12-01 00:30:00" &
  sdAggDayUstar_NEE_combined$date < "2016-02-21 00:30:00") | 
  (sdAggDayUstar_NEE_combined$date >= "2016-10-22" &
  sdAggDayUstar_NEE_combined$date < "2017-01-21"))



calculate_cumsum_unc <- function(data, ind, variable, start_mean, start_SD){  #variable = "NEE_f" or "mean"; ind = iter_ind or ustar_ind; data = NEE_method_cumsum

  # if start_point is new; use the first row value; if start_point is previous, use result from previous cumsum period to add to the first row
  data[1, ind] <- data[1, ind] + start_mean
  
  # calculate cumsum 
  data[ , ind] <- cumsum(data[ , ind])

  # for random forest, the flux value is calculated from the mean
  if(variable == "mean"){
      data[ , "mean"] <- rowMeans(data[ , ind])
  } else{
      data[, "mean"] <- data[, variable]
  }
  

  # calculate SD
  data[ , "SD_ori"] <- rowSds(as.matrix(data[ , ind]))
  
  # if start point is new, use SD as it is; if start point of SD is from the previous, sqrt(prev_SD^2 + current_SD^2)
  data[, "SD"] <- sqrt(data[ , "SD_ori"]^2 + start_SD^2)
  
  # data[ , "upper"] <- data[, variable] + data$SD
  # data[ , "lower"] <- data[, variable] - data$SD
  end_mean <- data[nrow(data), "mean"]
  end_SD <- data[nrow(data), "SD"]

  list(cumsum = data,
       end_mean = end_mean,
       end_SD = end_SD)
}



############---------- 2015-2016 period -------------############

# y_2015_2016 <- =date >= "2015-06-20" & date < "2016-06-20"

## MDS 1
NEE_MDS1_cumsum <- sdAggDayUstar_NEE_combined %>% filter(period == "2015-2016" & date <"2015-12-01") 
ustar_ind <- grep("NEE_", colnames(NEE_MDS1_cumsum), value = T)
NEE_MDS1_cumsum <- calculate_cumsum_unc(data = NEE_MDS1_cumsum,
                             ind = ustar_ind, 
                             variable = "NEE_f", 
                             start_mean = 0, 
                             start_SD = 0)

## long gaps RF1
NEE_RF1_cumsum <- sdAggDay_RF_NEE %>% filter(date >="2015-12-01 00:30:00" & date < "2016-02-21 00:30:00")
iter_ind <- grep("X", colnames(NEE_RF1_cumsum), value = T)
NEE_RF1_cumsum <- calculate_cumsum_unc(data = NEE_RF1_cumsum,
                             ind = iter_ind, 
                             variable = "mean", 
                             start_mean = NEE_MDS1_cumsum[[2]], 
                             start_SD = NEE_MDS1_cumsum[[3]])

## MDS 2
NEE_MDS2_cumsum <- sdAggDayUstar_NEE_combined %>% 
  filter(date >= "2016-02-21 00:30:00" & date <"2016-10-01 00:30:00") %>%
  calculate_cumsum_unc(data = .,
                             ind = ustar_ind, 
                             variable = "NEE_f", 
                             start_mean = NEE_RF1_cumsum[[2]], 
                             start_SD = NEE_RF1_cumsum[[3]])

## combine MDS and RF
NEE_cumsum_2015_2016 <- smartbind(NEE_MDS1_cumsum[[1]], NEE_RF1_cumsum[[1]], NEE_MDS2_cumsum[[1]]) %>% 
  select("date", "SD", "mean") %>% 
  mutate(upper = mean + SD, 
         lower = mean - SD, 
         period = "2015-2016", 
         date = date(date))


(NEE_cumsum_2015_2016 %>% 
  ggplot(aes(x = date(date), y = mean)) +
    geom_line() +
    geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha=0.1, 
              linetype="dashed",
              color="grey") +
    labs(x = "year", 
         y = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())


############---------- 2016-2017 period -------------############


## MDS 3
NEE_MDS3_cumsum <- sdAggDayUstar_NEE_combined %>% 
  filter(date >= "2016-10-01 00:30:00" & date < "2016-10-22 00:30:00") %>%
  calculate_cumsum_unc(data = .,
                             ind = ustar_ind, 
                             variable = "NEE_f", 
                             start_mean = 0, 
                             start_SD = 0)

## long gap RF2
NEE_RF2_cumsum <- sdAggDay_RF_NEE %>% 
  filter(date >= "2016-10-22 00:30:00" & date < "2017-01-21 00:30:00")%>% 
  calculate_cumsum_unc(data = .,
                             ind = iter_ind, 
                             variable = "mean", 
                             start_mean = NEE_MDS3_cumsum[[2]], 
                             start_SD = NEE_MDS3_cumsum[[3]])

## MDS4
NEE_MDS4_cumsum <- sdAggDayUstar_NEE_combined %>% 
  filter(date >= "2017-01-21 00:30:00" & date < "2017-10-01 00:30:00") %>% 
  calculate_cumsum_unc(data = .,
                             ind = ustar_ind, 
                             variable = "NEE_f", 
                             start_mean = NEE_RF2_cumsum[[2]], 
                             start_SD = NEE_RF2_cumsum[[3]])

## Combine MDS & RF
NEE_cumsum_2016_2017 <- smartbind(NEE_MDS3_cumsum[[1]], NEE_RF2_cumsum[[1]], NEE_MDS4_cumsum[[1]]) %>% 
  select("date", "SD", "mean") %>% 
  mutate(upper = mean + SD, 
         lower = mean - SD, 
         period = "2016-2017", 
         date = date(date))

(NEE_cumsum_2016_2017 %>% 
  ggplot(aes(x = date(date), y = mean)) +
    geom_line() +
    geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha=0.1, 
              linetype="dashed",
              color="grey") +
    labs(x = "year", 
         y = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())


############---------- 2017-2021 period -------------############

## set period
period <- unique(sdAggDayUstar_NEE_combined$period)[3:6]


cumsum_i <- NA
NEE_cumsum_2017_2021 <- NA
for(i in period){
  cumsum_i <- sdAggDayUstar_NEE_combined %>% filter(period == i) 
  cumsum_i <- calculate_cumsum_unc(data = cumsum_i, 
                                 ind = ustar_ind, 
                                 variable = "NEE_f", 
                                 start_mean = 0, 
                                 start_SD = 0)
  cumsum_i <- cumsum_i[[1]] %>% 
    select("date", "SD", "mean") %>% 
    mutate(upper = mean + SD, 
           lower = mean - SD, 
           period = i)
  if(i == "2017-2018") {
    NEE_cumsum_2017_2021 <- cumsum_i
  } else {
    NEE_cumsum_2017_2021 <- rbind(NEE_cumsum_2017_2021, cumsum_i)
  }
}

  
NEE_ustar_cumsum <- rbind(NEE_cumsum_2015_2016, NEE_cumsum_2016_2017, NEE_cumsum_2017_2021) %>% 
  group_by(period) %>%
  arrange(date) %>%
  mutate(order = row_number()) %>% 
  ungroup() %>%
  mutate(day_label = case_when(day(date) == 1L ~ format(date, "%b"),
                     TRUE ~ NA_character_)
         )

#############----------- ggplot ---------###########

# set x axis
x_break <- NEE_ustar_cumsum$order[!is.na(NEE_ustar_cumsum$day_label)][1:12]
x_label <- NEE_ustar_cumsum$day_label[!is.na(NEE_ustar_cumsum$day_label)][1:12]

(NEE_ustar_cumsum %>% 
  ggplot(aes(x = order, y = mean, color = factor(period), group = factor(period))) +
    geom_line(size = 1) +
    geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha=0.1, 
              linetype="dashed",
              fill = "grey") +
    labs(x = "Month", 
         y = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())

NEE_ustar_cumsum_annual <- NEE_ustar_cumsum %>% 
  group_by(period) %>% 
  filter(date == max(date)) %>%  # pick the last time of each day to get daily cumulative
  ungroup()



#####------------- combine cumulative random and u* uncertainty -------------####

aggUnc_NEE_cumsum <- left_join(NEE_ustar_cumsum, filter(aggDayRand_cum, date < "2021-06-20")) %>% 
  select(date, SD, mean, period, order, day_label, sdNEE) 

aggUnc_NEE_cumsum$sdNEE[is.na(aggUnc_NEE_cumsum$sdNEE)] <- 0

aggUnc_NEE_cumsum <- aggUnc_NEE_cumsum %>% 
  mutate(joint_sd = sqrt(SD^2 + sdNEE^2), 
         joint_CI = joint_sd * 1.96,
         upper = mean + joint_CI, 
         lower = mean - joint_CI)

NEE_cumsum_plot <- aggUnc_NEE_cumsum %>% 
  ggplot(aes(x = order, y = mean, color = factor(period), group = factor(period))) +
    geom_line(size = 1) +
    geom_ribbon(aes(ymin = lower, ymax = upper, 
                    fill = period, linetype = NA), 
              alpha=0.15) +
    scale_x_continuous(breaks = unique(x_break),
                       labels = unique(x_label)) +
    labs(x = "Month",  
         y = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
         colour = "", 
         fill = "") +
    theme_bw()



##########---------- annual aggregation of random and systematic uncertainty for NEE --------#############

NEE_joint_cumsum_annual <- aggUnc_NEE_cumsum %>% 
  group_by(period) %>% 
  filter(date == max(date)) %>%  # pick the last time of each day to get daily cumulative
  ungroup()



##############--------- GS/NGS aggregation of random & systematic uncertainty for NEE ---------##############

#-- for NGS----#
# just used daily joint uncertainty but cut it off at last day of NGS

NEE_NGS <- calculate_NGS(aggUnc_NEE_cumsum)

#-- for GS ---#

NEE_GS <- calculate_GS(sdAggDayUstar_NEE_combined, "NEE_f")

```

```{r cumsum uncertainty for RECO}


sdAggDayUstar_RECO <- set_period(sdAggDayUstar_RECO)

ustar_ind <- grep("Reco", colnames(sdAggDayUstar_RECO), value = T)

period <- unique(sdAggDayUstar_RECO$period) 
period <- period[!is.na(period)]

cumsum_i <- NA
Reco_cumsum_2015_2021 <- NA

for(i in period){
  cumsum_i <- sdAggDayUstar_RECO %>% filter(period == i) 
  cumsum_i <- calculate_cumsum_unc(data = cumsum_i, 
                                 ind = ustar_ind, 
                                 variable = "Reco", 
                                 start_mean = 0, 
                                 start_SD = 0)
  cumsum_i <- cumsum_i[[1]] %>% 
    select("date", "SD", "mean") %>% 
    mutate(CI = SD * 1.96, 
           upper = mean + CI, 
           lower = mean - CI, 
           period = i)
  if(i == "2015-2016") {
    Reco_cumsum_2015_2021 <- cumsum_i
  } else {
    Reco_cumsum_2015_2021 <- rbind(Reco_cumsum_2015_2021, cumsum_i)
  }
}

  
Reco_ustar_cumsum <- Reco_cumsum_2015_2021 %>% 
  group_by(period) %>%
  arrange(date) %>%
  mutate(order = row_number()) %>% 
  ungroup() %>%
  mutate(day_label = case_when(day(date) == 1L ~ format(date, "%b"),
                     TRUE ~ NA_character_)
         )

#############----------- ggplot ---------###########


x_break <- Reco_ustar_cumsum$order[!is.na(Reco_ustar_cumsum$day_label)][1:12]
x_label <- Reco_ustar_cumsum$day_label[!is.na(Reco_ustar_cumsum$day_label)][1:12]

Reco_cumsum_plot <- Reco_ustar_cumsum %>% 
  ggplot(aes(x = order, y = mean, color = factor(period), group = factor(period))) +
    geom_line(size = 1) +
    geom_ribbon(aes(ymin = lower, ymax = upper, 
              linetype=NA, fill = period), 
              alpha=0.15) +
    scale_x_continuous(breaks = unique(x_break),
                       labels = unique(x_label)) +
    labs(x = "Month", 
         y = bquote('Reco (g C' ~m^-2~ day^-1*')'), 
         colour = "", 
         fill = "") +
    theme_bw()


###########------- annual aggregation ---------##########

Reco_ustar_cumsum_annual <- Reco_ustar_cumsum %>% 
  group_by(period) %>% 
  filter(date == max(date)) %>%  # pick the last time of each day to get daily cumulative
  ungroup()

###########----------- GS/NGS aggregated uncertainty ---------########

#-- for NGS----#
# just used daily joint uncertainty but cut it off at last day of NGS


Reco_NGS <- calculate_NGS(Reco_ustar_cumsum)

#-- for GS ---# 

Reco_GS <- calculate_GS(sdAggDayUstar_RECO, "Reco")

```

```{r cumsum uncertainty for GPP}

# AAAAAAAAAAAAAAAAA

############---------- 2015-2016 period -------------############

sdAggDayUstar_GPP <- set_period(sdAggDayUstar_GPP)
### MDS
GPP_MDS1_cumsum <- sdAggDayUstar_GPP %>% filter(period == "2015-2016" & date <"2015-12-01") 
ustar_ind <- grep("GPP_", colnames(GPP_MDS1_cumsum), value = T)
GPP_MDS1_cumsum <- calculate_cumsum_unc(data = GPP_MDS1_cumsum,
                             ind = ustar_ind, 
                             variable = "GPP_f", 
                             start_mean = 0, 
                             start_SD = 0)

### long gap RF

# calculate SD RF NEE
iter_ind <- grep("X", colnames(sdAggDay_RF_NEE), value = T)
GPP_RF1_cumsum_NEE <- sdAggDay_RF_NEE %>% 
  filter(date >="2015-12-01 00:30:00" & date < "2016-02-21 00:30:00") %>% 
  calculate_cumsum_unc(data = .,
                       ind = iter_ind, 
                       variable = "mean", 
                       start_mean = 0, 
                       start_SD = 0)
ustar_ind <- grep("Reco", colnames(sdAggDayUstar_RECO), value = T)

# calculate SD MDS Reco
GPP_RF1_cumsum_RECO <- sdAggDayUstar_RECO %>% 
  filter(date >="2015-12-01 00:30:00" & date < "2016-02-21 00:30:00") %>% 
  calculate_cumsum_unc(data = .,
                       ind = ustar_ind, 
                       variable = "Reco", 
                       start_mean = 0, 
                       start_SD = 0)

# calculate SD GPP from Reco & NEE
GPP_RF1_cumsum <- data.frame(date = GPP_RF1_cumsum_NEE$cumsum$date, 
                             mean = GPP_MDS1_cumsum[[2]] + (GPP_RF1_cumsum_RECO$cumsum$mean - GPP_RF1_cumsum_NEE$cumsum$mean), 
                             SD = sqrt((GPP_RF1_cumsum_RECO$cumsum$SD^2) + 
                                        (GPP_RF1_cumsum_NEE$cumsum$SD^2 + 
                                        GPP_MDS1_cumsum[[3]]^2)))

### MDS 2 
ustar_ind <- grep("GPP", colnames(sdAggDayUstar_GPP), value = T)
GPP_MDS2_cumsum <- sdAggDayUstar_GPP %>% 
  filter(date >= "2016-02-21 00:30:00" & date <"2016-10-01 00:30:00") %>%
  calculate_cumsum_unc(data = .,
                             ind = ustar_ind, 
                             variable = "GPP_f", 
                             start_mean = GPP_RF1_cumsum[nrow(GPP_RF1_cumsum), "mean"], 
                             start_SD = GPP_RF1_cumsum[nrow(GPP_RF1_cumsum), "SD"])


# combine
GPP_cumsum_2015_2016 <- smartbind(select(GPP_MDS1_cumsum[[1]], c("date", "SD", "mean")),
                                  GPP_RF1_cumsum, 
                                  select(GPP_MDS2_cumsum[[1]], c("date", "SD", "mean"))) %>% 
  mutate(upper = mean + SD, 
         lower = mean - SD, 
         period = "2015-2016", 
         date = date(date))


(GPP_cumsum_2015_2016 %>% 
  ggplot(aes(x = date(date), y = mean)) +
    geom_line() +
    geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha=0.15, 
              linetype="dashed",
              color="grey") +
    labs(x = "year", 
         y = bquote('GPP (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())


############---------- 2016-2017 period -------------############

## not done


### MDS 3
GPP_MDS3_cumsum <- sdAggDayUstar_GPP %>% 
  filter(date >= "2016-10-01 00:30:00" & date < "2016-10-22 00:30:00") %>% 
  calculate_cumsum_unc(data = .,
                             ind = ustar_ind, 
                             variable = "GPP_f", 
                             start_mean = 0, 
                             start_SD = 0)

### long gap RF

# calculate SD RF NEE
iter_ind <- grep("X", colnames(sdAggDay_RF_NEE), value = T)
GPP_RF2_cumsum_NEE <- sdAggDay_RF_NEE %>% 
  filter(date >= "2016-10-22 00:30:00" & date < "2017-01-21 00:30:00")%>% 
  calculate_cumsum_unc(data = .,
                       ind = iter_ind, 
                       variable = "mean", 
                       start_mean = 0, 
                       start_SD = 0)
ustar_ind <- grep("Reco", colnames(sdAggDayUstar_RECO), value = T)

# calculate SD MDS Reco
GPP_RF2_cumsum_RECO <- sdAggDayUstar_RECO %>% 
  filter(date >= "2016-10-22 00:30:00" & date < "2017-01-21 00:30:00")%>% 
  calculate_cumsum_unc(data = .,
                       ind = ustar_ind, 
                       variable = "Reco", 
                       start_mean = 0, 
                       start_SD = 0)

# calculate SD GPP from Reco & NEE
GPP_RF2_cumsum <- data.frame(date = GPP_RF2_cumsum_NEE$cumsum$date, 
                             mean = GPP_MDS3_cumsum[[2]] + (GPP_RF2_cumsum_RECO$cumsum$mean - GPP_RF2_cumsum_NEE$cumsum$mean), 
                             SD = sqrt((GPP_RF2_cumsum_RECO$cumsum$SD^2) + 
                                        (GPP_RF2_cumsum_NEE$cumsum$SD^2 + 
                                        GPP_MDS3_cumsum[[3]]^2)))

### MDS 4 
ustar_ind <- grep("GPP", colnames(sdAggDayUstar_GPP), value = T)
GPP_MDS4_cumsum <- sdAggDayUstar_GPP %>% 
  filter(date >= "2017-01-21 00:30:00" & date < "2017-10-01 00:30:00") %>% 
  calculate_cumsum_unc(data = .,
                       ind = ustar_ind, 
                       variable = "GPP_f", 
                       start_mean = GPP_RF2_cumsum[nrow(GPP_RF2_cumsum), "mean"], 
                       start_SD = GPP_RF2_cumsum[nrow(GPP_RF2_cumsum), "SD"])


# combine
GPP_cumsum_2016_2017 <- smartbind(select(GPP_MDS3_cumsum[[1]], c("date", "SD", "mean")),
                                  GPP_RF2_cumsum, 
                                  select(GPP_MDS4_cumsum[[1]], c("date", "SD", "mean"))) %>% 
  mutate(upper = mean + SD, 
         lower = mean - SD, 
         period = "2016-2017", 
         date = date(date))


(GPP_cumsum_2016_2017 %>% 
  ggplot(aes(x = date(date), y = mean)) +
    geom_line() +
    geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha=0.1, 
              linetype="dashed",
              color="grey") +
    labs(x = "year", 
         y = bquote('GPP (g C' ~m^-2~ day^-1*')'), 
         colour = "") +
    theme_bw())



############---------- 2017-2021 period -------------############


sdAggDayUstar_GPP <- set_period(sdAggDayUstar_GPP)

period <- unique(sdAggDayUstar_GPP$period)[3:6]

cumsum_i <- NA
GPP_cumsum_2017_2021 <- NA
for(i in period){
  cumsum_i <- sdAggDayUstar_GPP %>% filter(period == i) 
  cumsum_i <- calculate_cumsum_unc(data = cumsum_i, 
                                 ind = ustar_ind, 
                                 variable = "GPP_f", 
                                 start_mean = 0, 
                                 start_SD = 0)
  cumsum_i <- cumsum_i[[1]] %>% 
    select("date", "SD", "mean") %>% 
    mutate(upper = mean + SD, 
           lower = mean - SD, 
           period = i)
  if(i == "2017-2018") {
    GPP_cumsum_2017_2021 <- cumsum_i
  } else {
    GPP_cumsum_2017_2021 <- rbind(GPP_cumsum_2017_2021, cumsum_i)
  }
}

  
GPP_ustar_cumsum <- rbind(GPP_cumsum_2015_2016, GPP_cumsum_2016_2017, GPP_cumsum_2017_2021) %>% 
  group_by(period) %>%
  arrange(date) %>%
  mutate(order = row_number()) %>% 
  ungroup() %>%
  mutate(day_label = case_when(day(date) == 1L ~ format(date, "%b"),
                     TRUE ~ NA_character_), 
         CI = SD * 1.96, 
         upper = mean + CI, 
         lower = mean - CI)

#############----------- ggplot ---------###########


x_break <- GPP_ustar_cumsum$order[!is.na(GPP_ustar_cumsum$day_label)][1:12]
x_label <- GPP_ustar_cumsum$day_label[!is.na(GPP_ustar_cumsum$day_label)][1:12]

GPP_cumsum_plot <- GPP_ustar_cumsum %>% 
  ggplot(aes(x = order, y = mean, color = factor(period), group = factor(period))) +
    geom_line(size = 1) +
    geom_ribbon(aes(ymin = lower, ymax = upper, 
                    fill = period, linetype = NA), 
              alpha=0.15) +
    scale_x_continuous(breaks = x_break,
                       labels = x_label) +
    labs(x = "Month", 
         y = bquote('GPP (g C' ~m^-2~ day^-1*')'), 
         color = "", 
         fill = "") +
    theme_bw()



##########---------- annual aggregation of systematic uncertainty of GPP ---------#######

GPP_ustar_cumsum_annual <- GPP_ustar_cumsum %>% 
  group_by(period) %>% 
  filter(date == max(date)) %>%  # pick the last time of each day to get daily cumulative
  ungroup()


##########--------- GS/NGS aggregation of random & systematic uncertainty for GPP ---------#######

#-- for NGS----#

GPP_NGS <- calculate_NGS(GPP_ustar_cumsum)

#-- for GS ---#

GPP_GS <- calculate_GS(sdAggDayUstar_GPP, "GPP_f")

```

```{r cumsum uncertainty for CH4}

# compute SD NEE from 20x iteration of RF NEE

result_RF_FCH4_wide <- result_RF_FCH4 %>% 
  pivot_wider(id_cols = DateTime, 
              names_from = iteration,
              values_from = FCH4_RF_filled) %>% 
  mutate(DateTime = date(DateTime)) %>% 
  rename(date = DateTime)

sdAggDay_RF_FCH4 <- compute_sdAggDayUstar(result_RF_FCH4_wide, "RF") %>% 
  set_period(.)

period <- unique(sdAggDay_RF_FCH4$period)
period <- period[which(!is.na(period))]
iter_ind <- grep("X", colnames(sdAggDay_RF_FCH4), value = T)

cumsum_i <- NA
FCH4_cumsum_2015_2021 <- NA
for(i in period){
  cumsum_i <- sdAggDay_RF_FCH4 %>% filter(period == i) 
  cumsum_i <- calculate_cumsum_unc(data = cumsum_i, 
                                 ind = iter_ind, 
                                 variable = "mean", 
                                 start_mean = 0, 
                                 start_SD = 0)
  cumsum_i <- cumsum_i[[1]] %>% 
    select("date", "SD", "mean") %>% 
    mutate(CI = SD * 1.96,
           upper = mean + CI, 
           lower = mean - CI, 
           period = i)
  if(i == "2015-2016") {
    FCH4_cumsum_2015_2021 <- cumsum_i
  } else {
    FCH4_cumsum_2015_2021 <- rbind(FCH4_cumsum_2015_2021, cumsum_i)
  }
}

  
FCH4_unc_cumsum <- FCH4_cumsum_2015_2021 %>% 
  group_by(period) %>%
  arrange(date) %>%
  mutate(order = row_number()) %>% 
  ungroup() %>%
  mutate(day_label = case_when(day(date) == 1L ~ format(date, "%b"),
                     TRUE ~ NA_character_)
         )

#############----------- ggplot ---------###########


x_break <- FCH4_unc_cumsum$order[!is.na(FCH4_unc_cumsum$day_label)][1:12]
x_label <- FCH4_unc_cumsum$day_label[!is.na(FCH4_unc_cumsum$day_label)][1:12]

FCH4_cumsum_plot <- FCH4_unc_cumsum %>% 
  ggplot(aes(x = order, y = mean, color = factor(period), group = factor(period))) +
    geom_line(size = 1) +
    geom_ribbon(aes(ymin = lower, ymax = upper, 
                    linetype = NA, fill = period), 
              alpha=0.1) +
    scale_x_continuous(breaks = unique(x_break),
                       labels = unique(x_label)) +
    labs(x = "Month", 
         y = bquote('FCH4 (g C' ~m^-2~ day^-1*')'), 
         colour = "", 
         fill = "") +
    theme_bw()


###### ---------- annual aggregation for CH4 ----------##########
FCH4_unc_cumsum_annual <- FCH4_unc_cumsum %>% 
  group_by(period) %>% 
  filter(date == max(date)) %>%  # pick the last time of each day to get daily cumulative
  ungroup()



######----------- GS/NGS aggregation for CH4 ----------########## 

#-- NGS --#
FCH4_NGS <- calculate_NGS(FCH4_unc_cumsum)

#-- GS ---# 
FCH4_GS <- calculate_GS(sdAggDay_RF_FCH4, "mean", iter_ind)

```

```{r save plots and docs}

print(NEE_cumsum_plot)
ggsave("plots/NEE_cumsum_plot.png")
print(GPP_cumsum_plot)
ggsave("plots/GPP_cumsum_plot.png")
print(Reco_cumsum_plot)
ggsave("plots/Reco_cumsum_plot.png")
print(FCH4_cumsum_plot)
ggsave("plots/FCH4_cumsum_plot.png")


# save calculations 
daily_unc <- data.frame(date = aggUnc_NEE_cumsum$date, 
                        NEE = aggUnc_NEE_cumsum$mean, 
                        NEE_CI = aggUnc_NEE_cumsum$joint_CI, 
                        GPP = GPP_ustar_cumsum$mean, 
                        GPP_CI = GPP_ustar_cumsum$CI, 
                        RECO = Reco_ustar_cumsum$mean, 
                        RECO_CI = Reco_ustar_cumsum$CI)
write.csv(daily_unc, paste0(here::here(), "/df/daily_filled_NEE.csv"))

```


```{r C and GHG budget} 


# calculate net C and GHG budgets along with their uncertainties
annual_budget <- data.frame(
                     date = NEE_joint_cumsum_annual$date, 
                     period = NEE_joint_cumsum_annual$period,
                     NEEgC_f_RF = NEE_joint_cumsum_annual$mean,
                     NEEgC_f_RF_CI = NEE_joint_cumsum_annual$joint_CI, 
                     GPPgC_f_RF = GPP_ustar_cumsum_annual$mean, 
                     GPPgC_f_RF_CI = GPP_ustar_cumsum_annual$CI, 
                     RecogC = Reco_ustar_cumsum_annual$mean, 
                     RecogC_CI = Reco_ustar_cumsum_annual$CI, 
                     CH4gC_f_RF = FCH4_unc_cumsum_annual$mean, 
                     CH4gC_f_RF_CI = FCH4_unc_cumsum_annual$CI
                     ) %>% 
  mutate(net_C_budget = NEEgC_f_RF + CH4gC_f_RF, 
         net_C_budget_CI = sqrt(NEEgC_f_RF_CI^2 + CH4gC_f_RF_CI^2), 
         CO2_seq = (NEEgC_f_RF + CH4gC_f_RF) * 44.01 / 12.01,  # in g CO2
         CO2_seq_CI = sqrt(NEEgC_f_RF_CI^2 + CH4gC_f_RF_CI^2) * 44.01 / 12.01,
         GHG_SGWP_20 = CO2_seq + (CH4gC_f_RF * 16.04 / 12.01 * 96),  # in g CO2-eq, using 20y SGWP = 96
         GHG_SGWP_20_CI = sqrt(CO2_seq_CI^2 + (CH4gC_f_RF_CI * 16.04 / 12.01 * 96)^2),
         GHG_SGWP_100 = CO2_seq + (CH4gC_f_RF * 16.04 / 12.01 * 45),  # in g CO2-eq, using 100y SGWP = 45
         GHG_SGWP_100_CI =  sqrt(CO2_seq_CI^2 + (CH4gC_f_RF_CI * 16.04 / 12.01 * 45)^2),
         GHG_GWP_20 = (NEEgC_f_RF * 44.01 / 12.01) + (CH4gC_f_RF * 16.04 / 12.01 * 84),  # in g CO2-eq, using 20y SGWP = 84, 
         GHG_GWP_20_CI = sqrt((NEEgC_f_RF_CI* 44.01 / 12.01)^2 + (CH4gC_f_RF_CI * 16.04 / 12.01 * 84)^2),
         GHG_GWP_100 = (NEEgC_f_RF * 44.01 / 12.01) + (CH4gC_f_RF * 16.04 / 12.01 * 28),  # in g CO2-eq, , using 100y SGWP = 28
         GHG_GWP_100_CI = sqrt((NEEgC_f_RF_CI* 44.01 / 12.01)^2 + (CH4gC_f_RF_CI * 16.04 / 12.01 * 28)^2), 
  )

write.csv(annual_budget, paste0(here::here(), "/df/annual_budget.csv"))


# calculate seasonal net C budget
seasonal_budget <- data.frame(period = year(NEE_GS$date)-1, 
                        GS_NEE = NEE_GS$mean,
                        GS_NEE_CI = NEE_GS$joint_CI, 
                        GS_GPP = GPP_GS$mean, 
                        GS_GPP_CI = GPP_GS$joint_CI, 
                        GS_Reco = Reco_GS$mean, 
                        GS_Reco_CI = Reco_GS$joint_CI, 
                        GS_CH4 = FCH4_GS$mean, 
                        GS_CH4_CI = FCH4_GS$joint_CI, 
                        NGS_NEE = NEE_NGS$mean,
                        NGS_NEE_CI = NEE_NGS$joint_CI, 
                        NGS_GPP = GPP_NGS$mean, 
                        NGS_GPP_CI = GPP_NGS$CI, 
                        NGS_Reco = Reco_NGS$mean, 
                        NGS_Reco_CI = Reco_NGS$CI, 
                        NGS_CH4 = FCH4_NGS$mean, 
                        NGS_CH4_CI = FCH4_NGS$CI
                        )
write.csv(seasonal_budget, paste0(here::here(), "/df/seasonal_budget.csv"))




```



