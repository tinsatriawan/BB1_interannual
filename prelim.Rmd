---
title: "Prelim"
author: "Tin Satriawan"
date: "20/01/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

source("data_wrangling.R")

library(phenofit)
library(rootSolve)
library(modelbased)



```



# Daily plots 


```{r functions , include = F, message = F, warning = F}

# function 
plot_daily <- function(data, variable, label, ma = 15) {
  # browser()
  if(ma == 1) {
    data %>% 
    ggplot() +
    geom_line(aes(x = date, y = {{variable}}), col = "navy") +
    labs(x = "year", 
         y = label) +
    # theme(legend.position="none") +
    theme_bw()
  } else {
    data %>% 
    ggplot() +
    geom_point(aes(x = date, y = {{variable}}, col = "daily")) +
    geom_line(aes(x = date, y = rollmean({{variable}}, ma, fill = NA), col = "smoothed")) +
    scale_color_manual(values = c("daily" = "lightblue", 
                                  "smoothed" = "navy")) +
    labs(x = "year", 
         y = label, 
         colour = "") +
    theme_bw()  
  }
}

plot_monthly <- function(main_data, mean_data){
  main_data%>%
  ggplot() +
    geom_bar(aes(x = month, y = value, fill = as.factor(period)), 
             position = position_dodge(), stat="identity") +
    geom_line(data = mean_data, aes(x = month, y = value, group = 1)) +
    geom_point(data = mean_data, aes(x = month, y = value, group = 1)) +
    facet_wrap(vars(variable_lab), ncol = 1,
               scales = "free_y",
               strip.position = "left", 
               # labeller = label_parsed
               ) +
    labs(x = "", y = "", fill = "Year") +
    theme_bw()+
    theme(strip.background = element_blank(),
          strip.placement = "outside") 
}

plot_monthly_anom <- function(main_data, anom_data){
  main_data%>%
  ggplot() +
    geom_bar(data= anom_data, aes(x = month, y = value), 
             position = position_dodge(), stat="identity") +
    geom_line(aes(x = month, y = value, group = 1)) +
    facet_wrap(vars(variable_lab), ncol = 1,
               scales = "free_y",
               strip.position = "left", 
               # labeller = label_parsed
               ) +
    # labs(x = "", y = "", fill = "Year") +
    scale_y_continuous(name = "", 
      sec.axis = sec_axis(~./2, name = "Productivity % of best", 
        labels = "")
      ) +
    theme_bw()+
    theme(strip.background = element_blank(),
          strip.placement = "outside") 
}

```


```{r calculate monthly fluxes, include = F, message = F, warning = F}

#### calculate daily cumsum ####
cumsum <- daily %>% 
  group_by(period) %>% 
  arrange(date) %>% 
  mutate(cumNEE = cumsum(NEEgC_f), 
         cumNEE_RF = cumsum(NEEgC_f_RF),
         cumReco = cumsum(RecogC),
         cumGPP = cumsum(GPPgC_f), 
         cumGPP_RF = cumsum(GPPgC_f_RF),
         cumCH4 = cumsum(CH4gC_f_RF)
         ) %>% 
  ungroup()


#### calculate monthly means ####
monthly <- daily %>% 
   ddply(c("floor_date"), summarize,
        length = length(NEEgC_f),
        NEEgC_f = mean(NEEgC_f) * length, # * length(NEEgC_f) for month^-1
        NEEgC_f_RF = mean(NEEgC_f_RF)* length,
        GPPgC_f = mean(GPPgC_f)* length,
        GPPgC_f_RF = mean(GPPgC_f_RF)* length,
        RecogC = mean(RecogC)* length,
        CH4gC_f = mean(CH4gC_f)* length,
        CH4gC_f_RF = mean(CH4gC_f_RF)* length) %>% 
  mutate(month_local = month(floor_date))

monthly_means <- monthly %>% 
  ddply("month_local", summarize, 
       NEEgC_f = mean(NEEgC_f, na.rm = T),
       NEEgC_f_RF = mean(NEEgC_f_RF, na.rm = T), 
       GPPgC_f = mean(GPPgC_f, na.rm = T),
       GPPgC_f_RF = mean(GPPgC_f_RF, na.rm = T), 
       RecogC = mean(RecogC, na.rm = T),
       CH4gC_f = mean(CH4gC_f, na.rm = T),
       CH4gC_f_RF = mean(CH4gC_f_RF, na.rm = T))


#### calculate monthly anomalies #####
monthly_anom <- monthly
for(i in 1:nrow(monthly)){ 
  monthly_anom[i, c(3:8)] <- monthly_anom[i, c(3:8)] -  
    monthly_means[monthly$month_local[i], c(2:7)]
}

```

## Non gap-filled $CO_2$ & $CH_4$ Fluxes 

**Non gap-filled** $CO_2$ & $CH_4$ fluxes. daily fluxes are calculated only from days with at least 60% half-hourly data available. 

```{r, message = F, warning = F}
co2_ngf <- plot_daily(data = daily.nGF, 
                   variable = co2gC, 
                   label = expression("CO"[2]*" flux (gC"*m^{-2}~day^{-1}*")"), 
                   ma = 1
                   )
ch4_ngf <- plot_daily(data = daily.nGF, 
                   variable = ch4gC, 
                   label = expression("CH"[4]*" flux (gC"*m^{-2}~day^{-1}*")"), 
                   ma = 1
                   )
(co2_ngf)
(ch4_ngf)

```

## Gap-filled daily $CO_2$ & $CH_4$ fluxes

```{r, message = F, warning = F}
RecogC <- plot_daily(data = daily, 
                   variable = RecogC, 
                   label = bquote('Reco (g C' ~m^-2~ day^-1*')'), 
                   ma = 1)
GPPgC_f <- plot_daily(data = daily, 
                   variable = GPPgC_f, 
                   label = bquote('GPP (g C' ~m^-2~ day^-1*')'), 
                   ma = 1)
GPPgC_f_RF <- plot_daily(data = daily, 
                   variable = GPPgC_f_RF, 
                   label = bquote('GPP RF(g C' ~m^-2~ day^-1*')'), 
                   ma = 1) 
NEEgC_f <- plot_daily(data = daily, 
                   variable = NEEgC_f, 
                   label = bquote('NEE (g C' ~m^-2~ day^-1*')'), 
                   ma = 1) 
NEEgC_f_RF <- plot_daily(data = daily, 
                   variable = NEEgC_f_RF, 
                   label = bquote('NEE RF(g C' ~m^-2~ day^-1*')'), 
                   ma = 1) 
CH4gC_f <- plot_daily(data = daily, 
                   variable = CH4gC_f, 
                   label = bquote('CH4 (g C' ~m^-2~ day^-1*')'), 
                   ma = 1)
CH4gC_f_RF <- plot_daily(data = daily, 
                   variable = CH4gC_f_RF, 
                   label = bquote('CH4 flux - random forest (g C' ~m^-2~ day^-1*')'), 
                   ma = 1)
(NEEgC_f)
(GPPgC_f)
(RecogC)
(CH4gC_f_RF)
(NEEgC_f_RF)
(GPPgC_f_RF)


GPP_comparison <- daily %>% 
  ggplot() +
    geom_line(aes(x = date, y = GPPgC_f_RF, col = "RF")) +
    geom_line(aes(x = date, y = GPP_f, col = "MDS")) +
    scale_color_manual(values = c("RF" = "blue", 
                                  "MDS" = "black")) +
    labs(x = "year", 
         y = "GPP (gC m-2 day-1)", 
         colour = "")  + 
  theme_bw()

NEE_comparison <- daily %>%
  ggplot() +
    # geom_line(aes(x = date, y = co2gC, col = "nGF"), data = daily.nGF) +
    geom_line(aes(x = date, y = NEEgC_f_RF, col = "RF"), data = daily) +
    geom_line(aes(x = date, y = NEE_f, col = "MDS"), data = daily) +
    scale_color_manual(values = c("RF" = "blue", 
                                  # "nGF" = "blue",
                                  "MDS" = "black")) +
    labs(x = "year", 
         y = "NEE (gC m-2 day-1)", 
         colour = "") +
    theme_bw()

ggplotly(NEE_comparison)
ggplotly(GPP_comparison)

```


## Meteorological variables 

```{r calculate monthly means for met variables, include = F, message = F, warning = F}

#### calculate monthly means for met variables ####
  
met_monthly <- BB_met %>% 
  ddply("floor_date", summarize, 
      # length = length(TS.5),
      TS.5 = mean(TS.5, na.rm = T),  # soil temp
      TS.10 = mean(TS.10, na.rm = T),
      TS.50 = mean(TS.50, na.rm = T),
      RH = mean(RH, na.rm = T),  # relative humidity
      PARin = mean(PARin, na.rm = T),  #u mol m-2 day-1
      SWin = mean(SWin, na.rm = T),
      VPD.y = mean(VPD.y, na.rm = T),
      Precip = sum(Precip, na.rm = T), # mm per month
      PA_2M = mean(PA_2M, na.rm = T),  # barrometric pressure from met
      Ta = mean(Ta, na.rm = T),  # air temp at 2 m
      SWC = mean(SWC, na.rm = T), 
      wtd = mean(wtd, na.rm = T), 
      min_TS.5 = min(TS.5, na.rm = T), 
      max_TS.5 = max(TS.5, na.rm = T),
      min_wtd = min(wtd, na.rm = T), 
      max_wtd = max(wtd, na.rm = T)) %>%
  mutate(month_local = month(floor_date))

met_monthly_means <- met_monthly %>% 
  ddply("month_local", summarize, 
      TS.5 = mean(TS.5, na.rm = T),  # soil temp
      TS.10 = mean(TS.10, na.rm = T),
      TS.50 = mean(TS.50, na.rm = T),
      RH = mean(RH, na.rm = T),  # relative humidity
      PARin = mean(PARin, na.rm = T),  
      SWin = mean(SWin, na.rm = T),
      VPD.y = mean(VPD.y, na.rm = T),
      Precip = mean(Precip, na.rm = T),
      PA_2M = mean(PA_2M, na.rm = T),  # barrometric pressure from met
      Ta = mean(Ta, na.rm = T),  # air temp at 2 m
      SWC = mean(SWC, na.rm = T), 
      wtd = mean(wtd, na.rm = T), 
      min_TS.5 = min(TS.5, na.rm = T), 
      max_TS.5 = max(TS.5, na.rm = T),
      min_wtd = min(wtd, na.rm = T), 
      max_wtd = max(wtd, na.rm = T))


#### calculate monthly anomalies for met variables ####

met_monthly_anom <- met_monthly
# for(i in 1:nrow(met_monthly)){ 
#   met_monthly_anom[i, c(3:14)] <- met_monthly_anom[i, c(3:14)] -  
#     met_monthly_means[met_monthly$month_local[i], c(2:13)]
#   }
for(i in 1:nrow(met_monthly_anom)){
  index <- which(met_monthly_means$month_local == met_monthly_anom$month_local[i])
  met_monthly_anom[i, c(2:13)] <- met_monthly_anom[i, c(2:13)] -
    met_monthly_means[index, c(2:13)]
  # print(i)
  }


```

```{r plotting met variables, message = F, warning = F}

### soil temperature ###

(TS <- BB_met %>% 
  # filter(date <= "2020-01-01") %>%
  ggplot() +
  geom_line(aes(x = date, y = TS.5, colour = "5 cm")) + 
  geom_line(aes(x = date, y = TS.10, colour = "10 cm")) +
  geom_line(aes(x = date, y = TS.50, colour = "50 cm")) + 
  scale_color_manual(values = c("5 cm" = "orange1", 
                                "10 cm" = "orangered1", 
                                "50 cm" = "red4"))+
  labs(x = "time", 
       y = expression('Soil temperature ('*~degree*C*')'), 
       colour = "")) + 
  theme_bw()

### relative humidity ###
(RH <- plot_daily(data = BB_met, 
                  variable = RH, 
                  label = "Relative humidity (%)", 
                  ma = 1)) 

### barrometric pressure ###
(PA <- plot_daily(data = BB_met, 
                  variable = PA_2M, 
                  label = "Barrometric pressure (%)", 
                  ma = 1)) 
(SWC <- plot_daily(data = BB_met, 
                  variable = SWC, 
                  label = bquote('soil water content (' ~m^3~ m^-3*')'), 
                  ma = 1))
(Ta <- plot_daily(data = BB_met, 
                  variable = Ta, 
                  label = expression('Air temperature ('*~degree*C*')'), 
                  ma = 1))
(PARin <- plot_daily(data = BB_met, 
                  variable = PARin, 
                  label = expression("PAR ("*mu*"mol"~m^{-2}~s^{-2}*")"), 
                  ma = 1))
(VPD <- plot_daily(data = BB_met, 
                  variable = VPD.y, 
                  label = "VPD", 
                  ma = 1))

(wtd <- BB_met %>% 
  # filter(date <= "2020-01-01") %>%
  ggplot() +
  geom_line(aes(x = date, y = wtd), col = "black") + 
  labs(x = "time", 
       y = "WTD (cm)") + 
  theme_bw())

  
```




# Monthly

## Monthly $CO_2$ & $CH_4$ fluxes

```{r plot monthly fluxes, fig.height = 8, fig.width = 8, message = F, warning = F}

flux_labels <- c(
  'NEE (gC m-2 month-1)',
  'GPP (gC m-2 month-1)',
  'Re (gC m-2 month-1)',
  'CH4 flux (gC m-2 month-1)'
)

# monthly_long <- monthly %>%
#   pivot_longer(cols = NEEgC_f_RF:CH4gC_f_RF, names_to = "variable", values_to = "value") %>% 
#   mutate(month = as.yearmon(floor_date),
#          # month_local = factor(month_local, levels = c(1:12)),
#          # month_abb = factor(month.abb[month_local], levels = month.abb), 
#          variable_lab = factor(variable, 
#                            levels = c("NEEgC_f_RF", "GPPgC_f_RF", "RecogC", "CH4gC_f_RF"),
#                            labels = flux_labels))
# 
# monthly_means_long <- monthly_means %>% 
#   pivot_longer(cols = NEEgC_f_RF:CH4gC_f_RF, names_to = "variable", values_to = "value") %>% 
#   mutate(month = as.yearmon(floor_date),
#          # month_local = factor(month_local, levels = c(1:12)),
#          # month_abb = factor(month.abb[month_local], levels = month.abb), 
#          variable_lab = factor(variable, 
#                            levels = c("NEEgC_f_RF", "GPPgC_f_RF", "RecogC", "CH4gC_f_RF"),
#                            labels = flux_labels))
# 
# monthly_anom_long <- monthly_anom %>% 
#   pivot_longer(cols = NEEgC_f_RF:CH4gC_f_RF, names_to = "variable", values_to = "value") %>% 
#   mutate(month = as.yearmon(floor_date),
#          # month_local = factor(month_local, levels = c(1:12)),
#          # month_abb = factor(month.abb[month_local], levels = month.abb), 
#          variable_lab = factor(variable, 
#                            levels = c("NEEgC_f_RF", "GPPgC_f_RF", "RecogC", "CH4gC_f_RF"),
#                            labels = flux_labels))
# 
# ggplotly(plot_monthly(monthly_long, monthly_means_long))

NEE <- daily%>%
ggplot() +
  geom_bar(data = monthly_anom, aes(x = floor_date, y = NEEgC_f_RF/15), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(NEEgC_f_RF, 7, fill = NA))) +
  scale_y_continuous(
    # limits = c(-4, 2),
    name = expression('NEE (g C' ~m^-2~ d^-1*')'),
    sec.axis = sec_axis(~.*15, name = bquote(Delta*~'NEE (g C' ~m^-2~ month^-1*')'))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year",
               date_labels = "%b %Y") +
  theme_bw()

GPP <- daily%>%
ggplot() +
  geom_bar(data = monthly_anom, aes(x = floor_date, y = (GPPgC_f_RF/15)), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(GPPgC_f_RF, 7, fill = NA))) +
  scale_y_continuous(
    # limits = c(-4, 2),
    name = expression('GPP (g C' ~m^-2~ d^-1*')'),
    sec.axis = sec_axis(~.*15, name = bquote(Delta*~'GPP (g C' ~m^-2~ month^-1*')'))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year",
               date_labels = "%b %Y") +
  theme_bw()


Reco <- daily%>%
ggplot() +
  geom_bar(data = monthly_anom, aes(x = floor_date, y = RecogC/25), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(RecogC, 7, fill = NA))) +
  scale_y_continuous(
    # limits = c(-4, 2),
    name = expression('Reco (g C' ~m^-2~ d^-1*')'),
    sec.axis = sec_axis(~.*15, name = bquote(Delta*~'Reco (g C' ~m^-2~ month^-1*')'))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year",
               date_labels = "%b %Y") +
  theme_bw()


CH4 <- daily%>%
ggplot() +
  geom_bar(data = monthly_anom, aes(x = floor_date, y = CH4gC_f_RF/10), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(CH4gC_f_RF, 7, fill = NA))) +
  scale_y_continuous(
    name = expression(CH[4]~'(g C' ~m^-2~ d^-1*')'),
    sec.axis = sec_axis(~.*10, name = bquote(Delta*~CH[4]~'(g C' ~m^-2~ month^-1*')'))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year",
               date_labels = "%b %Y") +
  theme_bw()


# NEE <- daily%>%
# ggplot() +
#   geom_point(data = BB1, aes(x = date, y = NEE_f_RF/10), color = "gray", stat = "identity") +
#   geom_line(aes(x = date, y = rollmean(NEEgC_f_RF, 7, fill = NA))) +
#   scale_y_continuous(
#     # limits = c(-4, 2),
#     name = expression('NEE (g C' ~m^-2~ d^-1*')'),
#     sec.axis = sec_axis(~.*10, name = bquote("NEE ("*mu*~"mol"~m^-2~ s^-1*')'))
#     ) +
#   labs(x = "") +
#   scale_x_date(date_breaks = "1 year", 
#                date_labels = "%b %Y") +
#   theme_bw()
# 
# GPP <- daily%>%
# ggplot() +
#   geom_point(data = BB1, aes(x = date, y = GPP_f_RF/5), color = "gray", stat = "identity") +
#   geom_line(aes(x = date, y = rollmean(GPPgC_f_RF, 7, fill = NA))) +
#   scale_y_continuous(
#     # limits = c(-4, 2),
#     name = expression('GPP (g C' ~m^-2~ d^-1*')'), 
#     sec.axis = sec_axis(~.*5, name = bquote("GPP ("*mu*~"mol"~m^-2~ s^-1*')'))
#     ) +
#   labs(x = "") +
#   scale_x_date(date_breaks = "1 year", 
#                date_labels = "%b %Y") +
#   theme_bw()
# 
# 
# Reco <- daily%>%
# ggplot() +
#   geom_point(data = BB1, aes(x = date, y = Reco), color = "gray", stat = "identity") +
#   geom_line(aes(x = date, y = rollmean(RecogC, 7, fill = NA))) +
#   scale_y_continuous(
#     # limits = c(-4, 2),
#     name = expression('Reco (g C' ~m^-2~ d^-1*')'), 
#     sec.axis = sec_axis(~., name = bquote("Reco ("*mu*~"mol"~m^-2~ s^-1*')'))
#     ) +
#   labs(x = "") +
#   scale_x_date(date_breaks = "1 year", 
#                date_labels = "%b %Y") +
#   theme_bw()
# 
# 
# CH4 <- daily%>%
# ggplot() +
#   geom_point(data = BB1, aes(x = date, y = FCH4_gf_RF/5), color = "gray", stat = "identity") +
#   geom_line(aes(x = date, y = rollmean(CH4gC_f_RF, 7, fill = NA))) +
#   scale_y_continuous(
#     name = expression(F[CH4]~'(g C' ~m^-2~ d^-1*')'), 
#     sec.axis = sec_axis(~.*5, name = bquote(F[CH4]~"("*mu*"mol"~m^-2~ s^-1*')'))
#     ) +
#   labs(x = "") +
#   scale_x_date(date_breaks = "1 year", 
#                date_labels = "%b %Y") +
#   theme_bw()


print(NEE)
ggsave("plots/NEE_daily.png")
print(GPP)
ggsave("plots/GPP_daily.png")
print(Reco)
ggsave("plots/Reco_daily.png")
print(CH4)
ggsave("plots/CH4_daily.png")
```

## Cumulative NEE, GPP, Reco 

```{r plot cumulative fluxes}
## plot cumulative 

fluxcum_labels <- c(
  bquote(NEE~'(g C' ~m^-2~')'),
  bquote(GPP~'(g C' ~m^-2~')'),
  bquote(Reco~'(g C' ~m^-2~')'),
  bquote(CH[4]~'(g C' ~m^-2~')')
)

# fluxcum_labels <- c(
#   'Cumulative NEE (gC m-2)',
#   'Cumulative GPP (gC m-2)',
#   'Cumulative Re (gC m-2)',
#   'Cumulative CH4 (gC m-2)'
# )

flux_cum <- cumsum %>% 
  select(c(date, cumNEE_RF, cumGPP_RF, cumReco, cumCH4, period, floor_date)) %>%
  pivot_longer(cols = c(cumNEE_RF, cumGPP_RF, cumReco, cumCH4), names_to = "variable", values_to = "value") %>%
  mutate(variable_lab = factor(variable, 
                           levels = c("cumNEE_RF", "cumGPP_RF", 
                                      "cumReco", "cumCH4"),
                           labels = fluxcum_labels)) %>% 
  group_by(variable,period) %>%
  arrange(date) %>%
  mutate(order = row_number()) %>% 
  ungroup() %>% 
  mutate(day_label = case_when(day(date) == 1L ~ format(date, "%b"),
                     TRUE ~ NA_character_)
         )
  
  
x_break <- flux_cum$order[!is.na(flux_cum$day_label)][1:48]
x_label <- flux_cum$day_label[!is.na(flux_cum$day_label)][1:48]
x_label

flux_cum %>% 
  ggplot(aes(x = order, y = value, color = factor(period), group = factor(period))) + 
  geom_line(size = 1) + 
  facet_wrap(vars(variable_lab), ncol = 1,
               scales = "free_y",
               strip.position = "left", 
               labeller = label_parsed
             ) +
  labs(x = "", y = "", color = "Year") +
  scale_x_continuous(
    breaks = unique(x_break),
    labels = unique(x_label)) +
  theme_bw() +
  theme(strip.background = element_blank(),
        strip.placement = "outside")
ggsave("plots/cumulative_flux.png")
```

## monthly met variables
```{r plot monthly met, fig.height = 10, fig.width = 8, message = F, warning = F} 
# met_labels <- c(
#   bquote(T[s]~'at 5 cm'),
#   # bquote('NEE (g C' ~m^-2~ day^-1*')'),
#   bquote(T[s]~'at 10 cm'),
#   bquote(T[s]~'at 50 cm'),
#   expression('RH("%")'), 
#   expression("PAR ("*mu*"mol"~m^{-2}~s^{-2}*")"), 
#   expression('Incoming~Shortwave'), 
#   expression('VPD'), 
#   expression('Precipitation~(mm)'), 
#   expression('Barrometric~pressure~("%")'), 
#   expression('Air temperature ('*~degree*C*')'), 
#   expression('WTD~before~~2018'), 
#   expression('WTD~after~~2018'), 
#   bquote('soil~water~content~(' ~m^3~ m^-3*')'), 
#   expression('WTD')
#   )

met_labels <- c(
  'Ts at 5 cm (C)',
  # bquote('NEE (g C' ~m^-2~ day^-1*')'),
  'Ts at 10 cm (C)',
  'Ts at 50 cm (C)',
  'RH("%")', 
  "PAR u mol m-2 s-2", 
  'Incoming Shortwave', 
  'VPD', 
  'Precipitation (mm)', 
  'Pa (%)', 
  'Ta (C)', 
  'WTD before 2018', 
  'WTD after 2018', 
  'SWC(m3 m-3)', 
  'WTD (cm)'
  )



TS5cm <- BB_met%>%
ggplot() +
  geom_bar(data = met_monthly_anom, aes(x = floor_date, y = TS.5*5), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(TS.5, 7, fill = NA))) +
  scale_y_continuous(
    # limits = c(-4, 2),
    name = bquote(T[s~5~cm]~'('*degree*'C)'),
    sec.axis = sec_axis(~./5, name = bquote(Delta*~T[s~5~cm]~'('*degree*'C)'))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year", 
               date_labels = "%b %Y") +
  theme_bw()

Tair <- BB_met%>%
ggplot() +
  geom_bar(data = met_monthly_anom, aes(x = floor_date, y = Ta*5), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(Ta, 7, fill = NA))) +
  scale_y_continuous(
    # limits = c(0, 30),
    name = bquote(T[air]~'('*degree*'C)'),
    sec.axis = sec_axis(~./5, name = bquote(Delta*~T[air]~'('*degree*'C)'))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year", 
               date_labels = "%b %Y") +
  theme_bw()

wtd <- BB_met%>%
ggplot() +
  geom_bar(data = met_monthly_anom, aes(x = floor_date, y = wtd*100), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = wtd*100)) +
  scale_y_continuous(
    # limits = c(0, 30),
    name = "WTD (cm)",
    sec.axis = sec_axis(~., name = bquote(Delta*~"WTD (cm)"))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year", 
               date_labels = "%b %Y") +
  theme_bw()

PARin <- BB_met%>%
ggplot() +
  geom_bar(data = met_monthly_anom, aes(x = floor_date, y = PARin*2), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(PARin, 7, fill = NA))) +
  scale_y_continuous(
    # limits = c(0, 30),
    name = bquote("PAR ("~mu~mol~m^{-2}~d^{-1}~")"),
    sec.axis = sec_axis(~./2, name = bquote(Delta*~"PAR ("~mu~mol~m^{-2}~d^{-1}~")"))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year", 
               date_labels = "%b %Y") +
  theme_bw()

precip <- BB_met%>%
ggplot() +
  geom_bar(data = met_monthly_anom, aes(x = floor_date, y = Precip/10), fill = "gray", stat = "identity") +
  geom_bar(aes(x = date, y = rollmean(Precip, 7, fill = NA)), stat = "identity", fill = "black") +
  scale_y_continuous(
    # limits = c(0, 30),
    name = bquote("Precipitation (mm"~d^-1~")"),
    sec.axis = sec_axis(~.*10, name = bquote(Delta*"Precip (mm"~month^-1~")"))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year", 
               date_labels = "%b %Y") +
  theme_bw()

VPD <- BB_met%>%
ggplot() +
  geom_bar(data = met_monthly_anom, aes(x = floor_date, y = VPD.y*2), fill = "gray", stat = "identity") +
  geom_line(aes(x = date, y = rollmean(VPD.y, 7, fill = NA))) +
  scale_y_continuous(
    # limits = c(0, 30),
    name = bquote("VPD (hPa"~d^-1~")"),
    sec.axis = sec_axis(~./2, name = bquote(Delta*~"VPD (hPa"~d^-1~")"))
    ) +
  labs(x = "") +
  scale_x_date(date_breaks = "1 year", 
               date_labels = "%b %Y") +
  theme_bw()

print(TS5cm)
ggsave("plots/TS5cm.png")
print(Tair)
ggsave("plots/Tair.png")
print(wtd)
ggsave("plots/wtd.png")
print(PARin)
ggsave("plots/PARin.png")
print(VPD)
ggsave("plots/vpd.png")
print(precip)
ggsave("plots/precip.png")

ggplotly(water)

```

# Annual 


## annual sums
```{r annual sums & means, message = F, warning = F}

day_count <- daily %>%
  drop_na(c(NEEgC_f_RF, RecogC, GPPgC_f_RF, CH4gC_f_RF)) %>%
  dplyr::count(period)


flux_an_sum <- daily %>%
  group_by(period) %>%
  summarise(NEEgC_f_RF = sum(NEEgC_f_RF, na.rm = T),
            RecogC = sum(RecogC, na.rm = T),
            GPPgC_f_RF = sum(GPPgC_f_RF, na.rm = T), 
            CH4_gC_RF = sum(CH4gC_f_RF, na.rm = T)) %>%
  ungroup() %>%
  mutate(day_count = day_count$n) %>% 
  drop_na()
  # filter(day_count > 200)

# set season 
daily$season <- NA
GS <- daily$month_local %in% c(4, 5, 6, 7, 8, 9)
NGS <- daily$month_local %in% c(10, 11, 12, 1, 2, 3)
daily$season[GS] <- "growing season"
daily$season[NGS] <- "non-growing season"

flux_season_sum <- daily %>%
  group_by(period, season) %>%
  summarise(NEEgC_f_RF = sum(NEEgC_f_RF, na.rm = T),
            RecogC = sum(RecogC, na.rm = T),
            GPPgC_f_RF = sum(GPPgC_f_RF, na.rm = T), 
            CH4_gC_RF = sum(CH4gC_f_RF, na.rm = T)) %>%
  ungroup()%>% 
  drop_na()

met_an_means <- BB_met %>%
  # mutate(year_local = year(date)) %>%
  group_by(period) %>%
  summarise(min_TS.5 = min(TS.5, na.rm = T), 
      max_TS.5 = max(TS.5, na.rm = T),
      min_wtd = min(wtd, na.rm = T), 
      max_wtd = max(wtd, na.rm = T), 
      day_wtd = count(wtd > 0, na.rm = T), 
      day_wtd2 = count(wtd < -0.1, na.rm = T),
      day_precip = count(Precip > 0, na.rm = T), 
      TS.5 = mean(TS.5, na.rm = T),  # soil temp
      TS.10 = mean(TS.10, na.rm = T),
      TS.50 = mean(TS.50, na.rm = T),
      RH = mean(RH, na.rm = T),  # relative humidity
      PARin = sum(PARin, na.rm = T),  
      SWin = mean(SWin, na.rm = T),
      VPD = mean(VPD.y, na.rm = T),
      Precip = sum(Precip, na.rm = T),
      PA = mean(PA_2M, na.rm = T),  # barrometric pressure from met
      Ta = mean(Ta, na.rm = T),  # air temp at 2 m
      SWC = mean(SWC, na.rm = T), 
      wtd = mean(wtd, na.rm = T)) %>%
  ungroup()%>% 
  drop_na()

met_season_sum <- BB_met %>%
  group_by(period, season) %>%
  summarise(min_TS.5 = min(TS.5, na.rm = T), 
      max_TS.5 = max(TS.5, na.rm = T),
      min_wtd = min(wtd, na.rm = T), 
      max_wtd = max(wtd, na.rm = T),
      day_wtd = count(wtd > 0, na.rm = T), 
      day_wtd2 = count(wtd < -0.1, na.rm = T),
      day_precip = count(Precip > 0, na.rm = T), 
      TS.5 = mean(TS.5, na.rm = T),  # soil temp
      TS.10 = mean(TS.10, na.rm = T),
      TS.50 = mean(TS.50, na.rm = T),
      RH = mean(RH, na.rm = T),  # relative humidity
      PARin = sum(PARin, na.rm = T),  
      SWin = mean(SWin, na.rm = T),
      VPD = mean(VPD.y, na.rm = T),
      Precip = sum(Precip, na.rm = T),
      PA = mean(PA_2M, na.rm = T),  # barrometric pressure from met
      Ta = mean(Ta, na.rm = T),  # air temp at 2 m
      SWC = mean(SWC, na.rm = T), 
      wtd = mean(wtd, na.rm = T)) %>%
  ungroup()%>%
  drop_na()

#   
# kable(flux_an_sum, caption = "Cumulative annual fluxes", 
#     col.names = c("year", 
#                   "NEE (gC m^2^ year^-1^)", 
#                   "Reco (gC m^2^ year^-1^)", 
#                   "GPP (gC m^2^ year^-1^)", 
#                   "CH~4~ (gC m^2^ year^-1^)", 
#                   "day_count")) %>% 
# kable_styling()
# 
# kable(met_an_means, caption = "Annual met variables", 
#       col.names = c("year", 
#                     "T~s~~5cm~", 
#                     "T~s~~10cm~",
#                     "T~s~~50cm~", 
#                     "RH(%)", 
#                     "PAR", 
#                     "SW~in~", 
#                     "VPD", 
#                     "Precip", 
#                     "PA", 
#                     "T~a~", 
#                     "SWC",
#                     "WTD")) %>%
# kable_styling()


write.csv(flux_an_sum, "flux_annual_summary.csv")
write.csv(flux_season_sum, "flux_season_summary.csv")
# write.csv(met_an_sum, "met_annual_summary.csv")
write.csv(met_an_means, "met_annual_summary.csv")
write.csv(met_season_sum, "met_season_summary.csv")

```

## influence of GPP and Re on NEE IAV
```{r relative influence of GPP and Reco on NEE variability}
# based on Schaefer et al. (1996)
# f GPP = variance of GPP/(variance of GPP + variance of Reco)

# for annual
var_GPP <- var(flux_an_sum$GPPgC_f_RF)
var_Reco <- var(flux_an_sum$RecogC)
f_GPP <- var_GPP/(var_GPP + var_Reco)
f_Reco <- var_Reco/(var_GPP + var_Reco)

f_GPP; f_Reco


# for growing season
var_GPP_GS <- var(filter(flux_season_sum, season == "growing season")$GPPgC_f_RF)
var_Reco_GS <- var(filter(flux_season_sum, season == "growing season")$RecogC)
f_GPP_GS <- var_GPP_GS/(var_GPP_GS + var_Reco_GS)
f_Reco_GS <- var_Reco_GS/(var_GPP_GS + var_Reco_GS)

f_GPP_GS; f_Reco_GS


# for non-growing season
var_GPP_NGS <- var(filter(flux_season_sum, season == "non-growing season")$GPPgC_f_RF)
var_Reco_NGS <- var(filter(flux_season_sum, season == "non-growing season")$RecogC)
f_GPP_NGS <- var_GPP_NGS/(var_GPP_NGS + var_Reco_NGS)
f_Reco_NGS <- var_Reco_NGS/(var_GPP_NGS + var_Reco_NGS)

f_GPP_NGS; f_Reco_NGS

```


## phenology indices 
```{r phenology}
date.origin <- as.Date("2000-01-01")

GPP.use <- weekly.GF[!is.na(weekly.nGF$co2gC), ]

# INPUT_GPP <- check_input(t = as.Date(weekly.GF$floor_date), 
                     # y = (weekly.GF$GPP_f_RF))  # use this
                     # y = weekly.nGF$co2gC + weekly.GF$Reco)
                     
INPUT_GPP <- check_input(t = as.Date(GPP.use$floor_date), 
                         y = GPP.use$GPP_f_RF)

INPUT_NEE <- check_input(t = as.Date(weekly.nGF$floor_date),
                     y = -(weekly.nGF$co2gC) + 8)
                     # y = -(weekly.GF$NEE_f_RF) + 8)

INPUT_Reco <- check_input(t = as.Date(weekly.GF$floor_date),
                     y = (weekly.GF$Reco))

iters <- 2
lambda <- 8
wFUN <- wTSM
r_max <- 0.2 
r_min <- 0.0
r_minPeakHeight <- 0.05
calendarYear <- FALSE
nptperyear <- 52



calc_phenology <- function(INPUT, ...){
  
  # growing seasons division
  brks2 <- season_mov(INPUT, 
                    rFUN = "smooth_wWHIT",
                    wFUN = wFUN,
                    iters = iters, wmin = 0,
                    IsOptim_lambda = F,
                    lambda = lambda,
                    nf = 3, frame = frame,
                    maxExtendMonth = 12,
                    r_max = r_max, r_min = r_min,
                    r_minPeakHeight = r_minPeakHeight,
                    calendarYear = calendarYear,
                    IsPlot = FALSE, IsPlot.OnlyBad = FALSE,
                    minpeakdistance = 1/3 * nptperyear, 
                    MaxPeaksPerYear = 1,
                    MaxTroughsPerYear = 4,
                    ypeak_min = 0.08)
  # curve fitting
  fit <- curvefits(INPUT, brks2, 
                 options = list(
                 methods = c("AG", "Zhang", "Beck", "Elmore"), #,"klos",, 'Gu'
                 wFUN = wBisquare,
                 nextend = 2, 
                 maxExtendMonth = 5, minExtendMonth = 1, 
                 minPercValid = 0.2,
                 print = FALSE,
                 iters = 2,
                 verbose = FALSE, ...))
  d_fit <- get_fitting(fit)
  d_gof <- get_GOF(fit)
  TRS <- c(0, 0.1)  # set threshold
  # extract transition dates
  l_pheno <- get_pheno(fit, wFUN = wBisquare, TRS = TRS, IsPlot = F) 
  pheno <- l_pheno$doy %>% melt_list("meth")
  # list output
  output <- list(brks2 = brks2, 
                 d_fit = d_fit,
                 fit = fit, 
                 pheno = pheno)
}

####----------------- phenology extracted from GPP --------------####

# extract phenology dates
pheno_GPP <- calc_phenology(INPUT_GPP)

# plot seasons
plot_season(INPUT_GPP, pheno_GPP$brks2)

# plot curve fitting
p_GPP <- plot_curvefits(pheno_GPP$d_fit, pheno_GPP$brks2, title = NULL, cex = 1.5, ylab = "GPP", angle = 0)
grid::grid.newpage()
grid::grid.draw(p_GPP)

# plot transition dates 
get_pheno(pheno_GPP$fit,  method = "Zhang", wFUN = wBisquare, IsPlot = T)

# get curvefit

for(i in 1: length(pheno_GPP$fit)){
  for(j in 1: length(pheno_GPP$fit[[i]]$model)){
    GPP_model <- pheno_GPP$fit[[i]]$model[[j]]
    GPP_fit <- NA
    GPP_fit <- data.frame(flag = names(pheno_GPP$fit)[[i]],
                          meth = names(pheno_GPP$fit[[i]]$model)[[j]],
                          y = GPP_model$zs$iter2,
                          t = as.Date(GPP_model$tout, origin = date.origin)
                          )
      if(j == 1) {
        GPP_per_meth <- GPP_fit
      } else{
        GPP_per_meth <- rbind(GPP_per_meth, GPP_fit)} 
      }
  if(i == 1) {
    GPP_fit_forplot <- GPP_per_meth
  } else{
    GPP_fit_forplot <- rbind(GPP_fit_forplot, GPP_per_meth)} 
}

####----------------- phenology extracted from NEE ---------------------####

# extract phenology dates
pheno_NEE <- calc_phenology(INPUT_NEE, use.rough = T)

# plot seasons
plot_season(INPUT_NEE, pheno_NEE$brks2)

# plot curve fitting
p_NEE <- plot_curvefits(pheno_NEE$d_fit, pheno_NEE$brks2, title = NULL, cex = 1.5, ylab = "NEE", angle = 0)
grid::grid.newpage()
grid::grid.draw(p_NEE)

# plot transition dates 
l_pheno <- get_pheno(pheno_NEE$fit, method = "Zhang", wFUN = wBisquare, IsPlot = T)




for(i in 1: length(pheno_NEE$fit)){
  for(j in 1: length(pheno_NEE$fit[[i]]$model)){
    NEE_model <- pheno_NEE$fit[[i]]$model[[j]]
    NEE_fit <- data.frame(flag = names(pheno_NEE$fit)[[i]],
                          y = NEE_model$zs$iter2 - 8,
                          t = as.Date(NEE_model$tout, origin = date.origin)
                          )
    NEE_fit <- data.frame(meth = as.factor(names(pheno_NEE$fit[[i]]$model)[[j]]), 
                          flag = names(pheno_NEE$fit)[[i]],
                          date.sos = ymd(NEE_fit$t[ceiling(zero_crossings(NEE_fit$y)[1])]), 
                          date.eos = ymd(NEE_fit$t[ceiling(zero_crossings(NEE_fit$y)[2])]) 
                          ) %>% 
               mutate(origin = ymd(paste0(substr(flag, 1, 4), "-01-01")), 
                     ZERO.sos = as.numeric(date.sos - origin), 
                     ZERO.eos = as.numeric(date.eos - origin))
      if(j == 1) {
        NEE_per_meth <- NEE_fit
      } else{
        NEE_per_meth <- rbind(NEE_per_meth, NEE_fit)} 
      }
  if(i == 1) {
    NEE_zero <- NEE_per_meth
  } else{
    NEE_zero <- rbind(NEE_zero, NEE_per_meth)} 
}


NEE_zero <- NEE_zero[order(NEE_zero$meth),]


for(i in 1: length(pheno_NEE$fit)){
  for(j in 1: length(pheno_NEE$fit[[i]]$model)){
    NEE_model <- pheno_NEE$fit[[i]]$model[[j]]
    NEE_fit <- NA
    NEE_fit <- data.frame(flag = names(pheno_NEE$fit)[[i]],
                          meth = names(pheno_NEE$fit[[i]]$model)[[j]],
                          y = NEE_model$zs$iter2 - 8,
                          t = as.Date(NEE_model$tout, origin = date.origin)
                          )
      if(j == 1) {
        NEE_per_meth <- NEE_fit
      } else{
        NEE_per_meth <- rbind(NEE_per_meth, NEE_fit)} 
      }
  if(i == 1) {
    NEE_fit_forplot <- NEE_per_meth
  } else{
    NEE_fit_forplot <- rbind(NEE_fit_forplot, NEE_per_meth)} 
}



####----------------- phenology extracted from Reco ---------------------####

# extract phenology dates
pheno_Reco <- calc_phenology(INPUT_Reco, use.rough = F)

# plot seasons
plot_season(INPUT_Reco, pheno_Reco$brks2)

# plot curve fitting
p_Reco <- plot_curvefits(pheno_Reco$d_fit, pheno_Reco$brks2, title = NULL, cex = 1.5, ylab = "Reco", angle = 0)
grid::grid.newpage()
grid::grid.draw(p_Reco)

# plot transition dates 
get_pheno(pheno_Reco$fit, method = "Zhang",  wFUN = wBisquare,  IsPlot = T)


####-----------------  Extract transition dates ---------------####


pheno_index <- data.frame(period = pheno_GPP$pheno$flag,
                          method = pheno_GPP$pheno$meth,
                          GPP_start_DER = pheno_GPP$pheno$DER.sos,  # start of growing season
                          GPP_end_DER = pheno_GPP$pheno$DER.eos,  # end of growing season
                          GPP_start_TRS = pheno_GPP$pheno$TRS1.sos, 
                          GPP_end_TRS = pheno_GPP$pheno$TRS1.eos, 
                          GPP_start_G = pheno_GPP$pheno$Greenup, 
                          GPP_end_G = pheno_GPP$pheno$Dormancy, 
                          GPP_maturity = pheno_GPP$pheno$Maturity, 
                          GPP_senescence = pheno_GPP$pheno$Senescence,
                          CUP_start = NEE_zero$ZERO.sos,  
                          CUP_end = NEE_zero$ZERO.eos, 
                          CUP_start_DER = pheno_NEE$pheno$DER.sos, 
                          CUP_end_DER = pheno_NEE$pheno$DER.eos, 
                          CUP_start_G = pheno_NEE$pheno$Greenup, 
                          CUP_end_G = pheno_NEE$pheno$Dormancy, 
                          CUP_start_TRS = pheno_NEE$pheno$TRS1.sos, 
                          CUP_end_TRS = pheno_NEE$pheno$TRS1.eos,
                          Reco_start = pheno_Reco$pheno$DER.sos, 
                          Reco_end = pheno_Reco$pheno$DER.eos,
                          NEE_peak = pheno_NEE$pheno$DER.pos) %>%
  mutate(CUP = CUP_end - CUP_start, 
         CUP_DER = CUP_end_DER - CUP_start_DER, 
         CUP_TRS = CUP_end_TRS - CUP_start_TRS, 
         CUP_G = CUP_end_G - CUP_start_G,
         GSP_DER = GPP_end_DER - GPP_start_DER,
         GSP_TRS = GPP_end_TRS - GPP_start_TRS,
         GSP_G = GPP_end_G - GPP_start_G,
         senescence_maturity = GPP_senescence - GPP_maturity,
         summer_lag = CUP_start - GPP_start_TRS, 
         autumn_lag = GPP_end_TRS - CUP_end, 
         RGR = (Reco_end - Reco_start)/(GPP_end_TRS - GPP_start_TRS)
         ) %>% 
  filter(method == "Zhang") %>% 
  mutate(period = c("2015-2016", "2016-2017", "2017-2018", "2018-2019", "2019-2020", "2020-2021"))


NEE_fit_forplot <- NEE_fit_forplot %>% filter(meth == "Zhang")
GPP_fit_forplot <- GPP_fit_forplot %>% filter(meth == "Zhang")

plot_ly(data = weekly.nGF, x = ~floor_date, y = ~-co2gC, type = "scatter", mode = "markers", name = "NEE") %>% 
  add_trace(data = weekly.GF, x = ~floor_date, y = ~GPP_f_RF, type = "scatter", mode = "markers", name = "GPP") %>% 
  add_trace(data = weekly.GF, x = ~floor_date, y = ~Reco, type = "scatter", mode = "markers", name = "Reco") %>% 
  add_trace(data = NEE_fit_forplot, x = ~t, y = ~y, type = "scatter", mode = "lines", name = "NEE_fit") %>% 
  add_trace(data = GPP_fit_forplot, x = ~t, y = ~y, type = "scatter", mode = "lines", name = "GPP_fit")

  





```


## Check calculation

```{r check annual pattern, message = F, warning = F}
# plot_monthly <- function(main_data, mean_data){
#   main_data%>%
#   ggplot() +
#     geom_bar(aes(x = month_abb, y = value, fill = as.factor(year_local)), 
#              position = position_dodge(), stat="identity") +
#     geom_line(data = mean_data, aes(x = month_abb, y = value, group = 1)) +
#     geom_point(data = mean_data, aes(x = month_abb, y = value, group = 1)) +
#     facet_wrap(vars(variable_lab), ncol = 1,
#                scales = "free_y",
#                strip.position = "left", 
#                # labeller = label_parsed
#                ) +
#     labs(x = "", y = "", fill = "Year") +
#     theme_bw()+
#     theme(strip.background = element_blank(),
#           strip.placement = "outside") 
# }


# correlation for annual values
corr <- left_join(met_an_means, flux_an_sum) %>%
  left_join(pheno_index) %>%
  mutate(year = substr(period, 1, 4))

# correlation for growing & non-growing season
corr_GS <- left_join(filter(flux_season_sum, season == "growing season"), filter(met_season_sum, season == "growing season"))%>%
  mutate(year = substr(period, 1, 4))

corr_NGS <- left_join(filter(flux_season_sum, season == "non-growing season"), filter(met_season_sum, season == "non-growing season"))%>%
  mutate(year = substr(period, 1, 4))

corr_an_GS <- left_join(flux_an_sum, filter(met_season_sum, season == "growing season"))%>%
  mutate(year = substr(period, 1, 4))

corr_an_NGS <- left_join(flux_an_sum, filter(met_season_sum, season == "non-growing season"))%>%
  mutate(year = substr(period, 1, 4))




flux_loop <- c("NEEgC_f_RF", "RecogC", "GPPgC_f_RF", "CH4_gC_RF")
met_loop <- c("TS.5", "Ta", "VPD", "wtd", "PARin", "Precip", "GPPgC_f_RF", "min_TS.5", "max_TS.5", "min_wtd", "max_wtd", "PA", "RH", "day_wtd", "day_wtd2", "day_precip")
phen_loop <- c("CUP_start", 
               "CUP", "CUP_DER", "CUP_TRS", "CUP_G",
               "GSP_DER", "GSP_TRS", "GSP_G", "senescence_maturity",
               "RGR", "summer_lag", "autumn_lag", "NEE_peak")


###### for annual correlation ########
for (i in flux_loop) {
  for (j in met_loop) { 
    eval(parse(text = paste0(i, '_vs_' , j, '<- corr %>% ggplot(aes_string(x = "', j,'", y = "',i,'")) + 
    geom_point(size = 3) + 
  geom_text(aes(label=year), size = 3, hjust=0.5, vjust=-0.8) +
  labs(x = "', j,'", y = "',i,'",  col= "") +  
  theme_bw() + 
  theme(legend.position="none")'
                             )))
    eval(parse(text = paste0("print(",i,"_vs_",j,")")))
    eval(parse(text = paste0("ggsave('plots/nocorr_",i,"_vs_",j,".png')")))
  }
}

## add correlation and regression line
for (i in flux_loop) {
  for (j in met_loop) { 
    eval(parse(text = paste0(i, '_vs_' , j, '<- corr %>% ggplot(aes_string(x = "', j,'", y = "',i,'")) + 
    geom_point(size = 3) + 
  geom_smooth(method = "lm", se = F, col = "black") +
  geom_text(aes(label=year), size = 3, hjust=0.5, vjust=-0.8) +
  labs(x = "', j,'", y = "',i,'",  col= "") +  
  stat_cor(size = 3.5) +
  theme_bw()+ 
  theme(legend.position="none")')))
    eval(parse(text = paste0("print(",i,"_vs_",j,")")))
    eval(parse(text = paste0("ggsave('plots/corr_",i,"_vs_",j,".png')")))
  }
}

## correlation for phenology 
for (i in flux_loop) {
  for (j in phen_loop) { 
    eval(parse(text = paste0(i, '_vs_' , j, '<- corr %>% ggplot(aes_string(x = "', j,'", y = "',i,'")) + 
    geom_point(size = 3) + 
  geom_smooth(method = "lm", se = F, col = "black") +
  geom_text(aes(label=year), size = 3, hjust=0.5, vjust=-0.8) +
  labs(x = "', j,'", y = "',i,'",  col= "") +  
  stat_cor(size = 3.5) +
  theme_bw()+ 
  theme(legend.position="none")')))
    eval(parse(text = paste0("print(",i,"_vs_",j,")")))
    eval(parse(text = paste0("ggsave('plots/corr_phen_",i,"_vs_",j,".png')")))
  }
}
  


###### for growing season correlation ########
## add correlation and regression line
for (i in flux_loop) {
  for (j in met_loop) { 
    eval(parse(text = paste0(i, '_vs_' , j, '<- corr_GS %>% ggplot(aes_string(x = "', j,'", y = "',i,'")) + 
    geom_point(size = 3) + 
  geom_smooth(method = "lm", se = F, col = "black") +
  ggtitle("GS") + 
  geom_text(aes(label=year), size = 3, hjust=0.5, vjust=-0.8) +
  labs(x = "', j,'", y = "',i,'",  col= "") +  
  stat_cor(size = 3.5) +
  theme_bw()+ 
  theme(legend.position="none")')))
    eval(parse(text = paste0("print(",i,"_vs_",j,")")))
    eval(parse(text = paste0("ggsave('plots/corr_GS_",i,"_vs_",j,".png')")))
  }
}


###### for non-growing season correlation #####
for (i in flux_loop) {
  for (j in met_loop) { 
    eval(parse(text = paste0(i, '_vs_' , j, '<- corr_NGS %>% ggplot(aes_string(x = "', j,'", y = "',i,'")) + 
    geom_point(size = 3) + 
  geom_smooth(method = "lm", se = F, col = "black") +
  ggtitle("NGS") + 
  geom_text(aes(label=year), size = 3, hjust=0.5, vjust=-0.8) +
  labs(x = "', j,'", y = "',i,'",  col= "") +  
  stat_cor(size = 3.5) +
  theme_bw()+ 
  theme(legend.position="none")')))
    eval(parse(text = paste0("print(",i,"_vs_",j,")")))
    eval(parse(text = paste0("ggsave('plots/corr_NGS_",i,"_vs_",j,".png')")))
  }
}

###### annual flux vs growing season correlation #####
for (i in flux_loop) {
  for (j in met_loop) { 
    eval(parse(text = paste0(i, '_vs_' , j, '<- corr_an_GS %>% ggplot(aes_string(x = "', j,'", y = "',i,'")) + 
    geom_point(size = 3) + 
  geom_smooth(method = "lm", se = F, col = "black") +
  ggtitle("annual flux vs GS variable") + 
  geom_text(aes(label=year), size = 3, hjust=0.5, vjust=-0.8) +
  labs(x = "', j,'", y = "',i,'",  col= "") +  
  stat_cor(size = 3.5) +
  theme_bw()+ 
  theme(legend.position="none")')))
    eval(parse(text = paste0("print(",i,"_vs_",j,")")))
    eval(parse(text = paste0("ggsave('plots/corr_an_vs_GS_",i,"_vs_",j,".png')")))
  }
}

###### annual flux vs non-growing season correlation #####
for (i in flux_loop) {
  for (j in met_loop) { 
    eval(parse(text = paste0(i, '_vs_' , j, '<- corr_an_NGS %>% ggplot(aes_string(x = "', j,'", y = "',i,'")) + 
    geom_point(size = 3) + 
  geom_smooth(method = "lm", se = F, col = "black") +
  ggtitle("annual flux vs NGS variable") + 
  geom_text(aes(label=year), size = 3, hjust=0.5, vjust=-0.8) +
  labs(x = "', j,'", y = "',i,'",  col= "") +  
  stat_cor(size = 3.5) +
  theme_bw()+ 
  theme(legend.position="none")')))
    eval(parse(text = paste0("print(",i,"_vs_",j,")")))
    eval(parse(text = paste0("ggsave('plots/corr_an_vs_NGS_",i,"_vs_",j,".png')")))
  }
}


####### correlation matrix ##########

install.packages("corrplot")
library(corrplot)

source("http://www.sthda.com/upload/rquery_cormat.r")
rquery.cormat(corr[, 2:21])




grid.arrange(ncol = 3, 
             NEEgC_f_RF_vs_PARin, 
             NEEgC_f_RF_vs_Ta, 
             NEEgC_f_RF_vs_TS.5, 
             NEEgC_f_RF_vs_VPD, 
             NEEgC_f_RF_vs_wtd, 
             NEEgC_f_RF_vs_Precip)

grid.arrange(ncol = 3, 
             RecogC_vs_PARin, 
             RecogC_vs_Ta, 
             RecogC_vs_TS.5, 
             RecogC_vs_VPD, 
             RecogC_vs_wtd, 
             RecogC_vs_Precip)

grid.arrange(ncol = 3, 
             GPPgC_f_RF_vs_PARin, 
             GPPgC_f_RF_vs_Ta, 
             GPPgC_f_RF_vs_TS.5, 
             GPPgC_f_RF_vs_VPD, 
             GPPgC_f_RF_vs_wtd, 
             GPPgC_f_RF_vs_Precip)

grid.arrange(ncol = 3, 
             CH4_gC_RF_vs_PARin, 
             CH4_gC_RF_vs_Ta, 
             CH4_gC_RF_vs_TS.5, 
             CH4_gC_RF_vs_VPD, 
             CH4_gC_RF_vs_wtd, 
             CH4_gC_RF_vs_Precip)


```

```{r daily pattern}

daily.nGF <- left_join(daily.nGF, BB_met)
daily.nGF <- daily.nGF %>% drop_na()

daily.nGF %>% ggplot(aes(x = TS.5, y = ch4gC)) + 
  geom_point() + 
  geom_smooth(method = "loess", se = F)

colnames(daily)
colnames(BB_met)

daily_met_flux <- left_join(daily, BB_met) 

daily_met_flux %>% 
  filter(TS.5 > 18) %>%
  ggplot(aes(x = wtd, y = CH4gC_f_RF)) + 
  geom_point() + 
  geom_smooth(method = "loess", se = F, span = 1)

```


## Remote Sensing Indices

```{r read remote sensing indices}

# read csv exported from GEE
RS_indices <- read.csv("G:/My Drive/Burns_Bog/BB1_GEE_Indices.csv", header = T, skip = 1) %>% 
  select(-1)

# get date from landsat ID
RS_indices$date <- RS_indices$id %>% 
  substr(13, 20) %>%
  as.POSIXct(format = "%Y%m%d")

RS_indices_daily <- RS_indices %>%
  filter(latitude >= 49.128682195765705 & latitude <= 49.13011436654678) %>%
  filter(longitude >= -122.98623037567138 & longitude <= -122.98365545501709) %>%
  ddply("date", summarize, 
        MNDWI_SW1 = mean(MNDWI_SW1, na.rm = T), 
        MNDWI_SW2 = mean(MNDWI_SW2, na.rm = T), 
        NDVI = mean(NDVI, na.rm = T), 
        NDWI = mean(NDWI, na.rm = T), 
        NDWI_gao = mean(NDWI_gao, na.rm = T), 
        LST = mean(CELSIUS, na.rm = T))

daily_for_RS <- left_join(daily, BB_met) %>% 
  select(date, NEE_f_RF, GPP_f_RF, Reco, CH4gC_f_RF, 
         TS.5, TS.10, Precip, Ta, wtd,
         period, season, year_local, month_local) %>%
  mutate(
  NEE_7 = rollmean(NEE_f_RF, 7, fill = NA), 
  GPP_7 = rollmean(GPP_f_RF, 7, fill = NA), 
  Reco_7 = rollmean(Reco, 7, fill = NA), 
  CH4_7 = rollmean(CH4gC_f_RF, 7, fill = NA),
  TS.5_7 = rollmean(TS.5, 7, fill = NA), 
  Precip_7 = rollmean(Precip, 7, fill = NA), 
  Ta_7 = rollmean(Ta, 7, fill = NA), 
  wtd_7 = rollmean(wtd, 7, fill = NA))


RS_indices <- left_join(RS_indices_daily, daily_for_RS) %>% drop_na()


# calculate annual RS indices (mean, peak, median)
RS_indices %>% 
  plot_ly(x = ~date, y = ~NDVI, type = "scatter", mode= "lines", name = "NDVI") %>% 
  add_trace(y =~NDWI_gao, type = "scatter", mode = "lines", name = "NDWI") %>% 
  add_trace(y =~GPP_7, type = "scatter", mode = "lines", name = "GPP_7") %>% 
  add_trace(y =~LST, type = "scatter", mode = "lines", name = "LST") %>% 
  add_trace(y =~Ta_7, type = "scatter", mode = "lines", name = "Ta_7")


RS_indices %>% 
  plot_ly(x =~NDVI, y =~GPP_7, type = "scatter", mode = "markers")

```


## Others
```{r, eval = F, include = F}
# check with Nick 

# Nick <-  daily %>% 
#   filter(date >= "2015-06-16" & date <= "2016-06-15") %>%
#   group_by(year_local, month_local) %>% 
#   summarize(NEEgC_f = sum(NEEgC_f),
#         RecogC = sum(RecogC),
#         GPPgC_f = sum(GPPgC_f), 
#         CH4_gC = sum(CH4gC_f)) %>% 
#   ungroup()
# sum_Nick <- sum(as.numeric(Nick$GPPgC_f))
# sum_Nick /12 * 44

```

```{r, eval = F, include = F}

# Check with Marion 


Marion <- daily %>% 
  filter(year_local == 2020) %>% 
  mutate(cumNEE = cumsum(NEEgC_f), 
         cumReco = cumsum(RecogC),
        cumGPP = cumsum(GPPgC_f), 
        cumCH4 = cumsum(CH4gC_f))
plot_daily(data = Marion, 
           variable = cumNEE, 
           label = expression("cumulative NEE (gC "*m^{-2}~day^{-1}*")"), 
           ma = 1
           )
plot_daily(data = Marion, 
           variable = cumReco, 
           label = expression("cumulative Reco (gC "*m^{-2}~day^{-1}*")"), 
           ma = 1
           )
plot_daily(data = Marion, 
           variable = cumGPP, 
           label = expression("cumulative GPP (gC "*m^{-2}~day^{-1}*")"), 
           ma = 1
           )
plot_daily(data = Marion, 
           variable = cumCH4, 
           label = expression("cumulative CH4 (gC "*m^{-2}~day^{-1}*")"), 
           ma = 1
           )
```



